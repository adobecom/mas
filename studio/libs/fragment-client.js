var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var r,s,a,n={exports:{}};r=n,s=n.exports,a=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==e)return e;throw new Error("unable to locate global object")}(),r.exports=s=a.fetch,a.fetch&&(s.default=a.fetch.bind(a)),s.Headers=a.Headers,s.Request=a.Request,s.Response=a.Response;var i=t(n.exports);const o=["cards","collections","entries"],l=[...o,"tags"];function c(e){const{fields:t,references:r}=e,s={};r&&r.forEach((e=>{const{type:t,path:r,id:a}=e;"content-fragment"===t&&(s[r]=a)}));const a=t.reduce(((e,{name:t,multiple:r,values:a,mimeType:n})=>(o.includes(t)?e[t]=a.map((e=>"string"==typeof e&&s[e]||e)):e[t]="text/html"===n?{mimeType:n,value:a[0]}:r?a:a[0],e)),{});return a}function u(e,t){if(!e)return[];const r=[];for(const[s,a]of Object.entries(e))l.includes(s)&&Array.isArray(a)&&a.forEach((e=>{if(t[e]){const a={fieldName:s,identifier:e,referencesTree:[]},n=t[e];"content-fragment"===n.type&&(a.referencesTree=u(n.value.fields,t)),r.push(a)}}));return r}function f(e){if(!e.references)return e;const t=(e,r)=>{const s=c(r);r.references&&r.references.length>0&&r.references.forEach((r=>{Object.keys(e).find((e=>e===r.id))||t(e,r)})),e[r.id]={type:r.type,value:{name:r.name||"",title:r.title||"",description:r.description||"",path:r.path||"",id:r.id,model:{id:r.model?.id},fields:s}},r.tags&&Array.isArray(r.tags)&&r.tags.forEach((t=>{t&&t.id&&!e[t.id]&&(e[t.id]={type:"tag",value:{id:t.id,name:t.name||"",title:t.title||"",path:t.path||"",description:void 0!==t.description?t.description:null,i18n:t.i18n||[],titlePath:t.titlePath||""}})}))};return e.references&&(e.references=e.references.reduce(((e,r)=>(t(e,r),e)),{}),e.referencesTree=u(e.fields,e.references)),e}function d(e,t="info"){return`[${t}][${e.api_key}][${e.requestId}][${e.id}][${e.locale}][${e.loggedTransformer}]`}function p(e,t){console.log(`${d(t)} ${e}`)}function m(e,t){console.error(`${d(t,"error")} ${e}`)}function y(e,t){t.debugLogs&&console.log(`${d(t,"debug")} ${e()}`)}async function h(e){let t=e.message??"nok";try{const r=await e.json();t=r?.detail}catch(e){}return t}async function b(e,t){let r=await e.json();return t.preview&&Array.isArray(r.fields)&&(p("massaging old school schema for preview",t),r=function(e){return e.fields=c(e),f(e)}(r)),r}function g(e,t){return new Promise(((r,s)=>{setTimeout((()=>{const r=new Error(`Request timed out after ${e}ms`);r.isTimeout=!0,t?.(r),s(r)}),e)}))}function w(e,t){return e.marks=e.marks||{},e.marks[t]=performance.now().toFixed(2)}function x(e,t,r=t){const s={label:t,duration:0};if(e.marks&&e.marks[r]){const t=e.marks.start;s.startTime=(e.marks[r]-t).toFixed(2),s.duration=(performance.now()-e.marks[r]).toFixed(2)}return e.measures=e.measures||[],e.measures.push(s),s}async function v(e,t,r,s){try{w(t,s);const a=i(e,{headers:t.DEFAULT_HEADERS}),n=await Promise.race([a,g(r)]),o=x(t,s),l=200===n.status;return n.message=l?"ok":n.message||await h(n),p(`fetch ${e} (${n?.status}) ${n?.message} in ${o.duration}ms`,t),y((()=>`response headers: ${JSON.stringify(Object.fromEntries(n.headers.entries()))}`),t),l?{status:200,message:"ok",body:await b(n,t)}:n}catch(r){const a=x(t,`fetch-error-${s}`,s);return r.isTimeout?(m(`[fetch] ${e} timed out after ${a.duration}ms`,t),{...t,status:504,message:"fetch timeout"}):(m(`[fetch] ${e} fetch error: ${r.message} after ${a.duration}ms`,t),{...t,status:503,message:"fetch error"})}}async function $(e,t,r){w(t,`${r}`);const{retries:s=3,fetchTimeout:a=2e3,retryDelay:n=100}=t.networkConfig||{};let i,o=n;for(let n=0;n<s&&(i=await v(e,t,a,`fetch-${r}-${n}`),[503,504].includes(i.status));n++)p(`fetch ${e} (attempt #${n}) failed with status ${i.status}, retrying in ${o}ms...`,t),await new Promise((e=>setTimeout(e,o))),o*=2;return x(t,`main-fetch-${r}`,r),i}const T={name:"corrector",process:async function(e){const{priceLiterals:t}=e.body;for(const[r,s]of Object.entries(t))"string"==typeof s&&/^(\{\{)?price-literal-/.test(s)&&(y((()=>`no placeholder has been authored for ${r}`),e),delete e.body.priceLiterals[r]);return e}},L=/\/content\/dam\/mas\/(?<surface>[\w-_]+)\/(?<parsedLocale>[\w-_]+)\/(?<fragmentPath>.+)/;function k(e){return`${e?.url?e.url:"https://odin.adobe.com/adobe/sites/fragments"}`}function _(e,t=!1,r){return`${function(e,t){return`${k(t)}/${e}`}(e,r)}${t?"?references=all-hydrated":""}`}function E(e,t,r,s){return`${k(s)}?path=/content/dam/mas/${e}/${t}/${r}`}const R=/{{(\s*([\w\-\_]+)\s*)}}/gi,A="replace";async function P(e){if(e.hasExternalDictionary)return e.dictionary;const t=e.dictionary||{},r=e.dictionaryId??await async function(e){const{surface:t,locale:r,preview:s}=e,a=E(t,r,"dictionary/index",s),n=await $(a,e,"dictionary-id");if(200==n.status){const{items:t}=n.body;if(t?.length>0){const r=t[0].id;return e.dictionaryId=r,r}}return null}(e);if(!r)return t;const s=await $(_(r,!0,e.preview),e,"dictionary");if(200==s.status){const e=s.body.references;return Object.keys(e).forEach((r=>{const s=e[r]?.value?.fields;s?.key&&(t[s.key]=function(e){return(e.value||e.richTextValue?.value||"").replace(/[\u0000-\u001F\u007F-\u009F]/g,"").replace(/"/g,'\\"')}(s))})),t}return t}function j(e,t,r){const s=e.matchAll(R);let a="",n=0;for(const i of s){const s=i[1];a+=e.slice(n,i.index);let o=null==t[s]||r.includes(s)?s:t[s];o?.match(R)&&(r.push(s),o=j(o,t,r),r.pop()),a+=o,n=i.index+i[0].length}return a+=e.slice(n),a}const S={name:A,process:async function(e){let t=e.body,r=JSON.stringify(t);if(r.match(R)){let s=await(e?.promises?.[A]);if(s=s?{...s,...e.dictionary}:await P(e),s&&Object.keys(s).length>0){r=j(r,s,[]);try{t=JSON.parse(r)}catch(t){m(`[replace] ${t.message}`,e),y((()=>`[replace] invalid json: ${r}`),e)}}}else p("no placeholders found in fragment content",e);return{...e,status:200,body:t}},init:async function(e){return e.dictionaryId?await P(e):null}};function O(e,t){const{locale:r}=t;e.settings={},!1!==e?.fields?.showSecureLabel&&(e.settings.secureLabel="{{secure-label}}"),null!=e?.fields?.showPlanType&&(e.settings.displayPlanType=e?.fields?.showPlanType),e?.fields?.perUnitLabel&&(e.priceLiterals??={},e.priceLiterals.perUnitLabel=e.fields.perUnitLabel),"en_US"===r&&(e.settings.displayPlanType??=!0)}function U(e,t){const{locale:r}=t;"en_AU"===r&&(e.settings={displayPlanType:!0,displayAnnual:!0})}const F={name:"settings",process:async function(e){var t;return(t=e.body)&&(t.priceLiterals={recurrenceLabel:"{{price-literal-recurrence-label}}",recurrenceAriaLabel:"{{price-literal-recurrence-aria-label}}",perUnitLabel:"{{price-literal-per-unit-label}}",perUnitAriaLabel:"{{price-literal-per-unit-aria-label}}",freeLabel:"{{price-literal-free-label}}",freeAriaLabel:"{{price-literal-free-aria-label}}",taxExclusiveLabel:"{{price-literal-tax-exclusive-label}}",taxInclusiveLabel:"{{price-literal-tax-inclusive-label}}",alternativePriceAriaLabel:"{{price-literal-alternative-price-aria-label}}",strikethroughAriaLabel:"{{price-literal-strikethrough-aria-label}}",planTypeLabel:"{{price-literal-plan-type-label}}"}),e.body?.fields?.variant?.startsWith("plans")&&O(e.body,e),"mini"===e.body?.fields?.variant&&U(e.body,e),"L2NvbmYvbWFzL3NldHRpbmdzL2RhbS9jZm0vbW9kZWxzL2NvbGxlY3Rpb24"===e.body?.model?.id&&function(e){e.body?.references&&Object.entries(e.body.references).forEach((([t,r])=>{if(r&&"content-fragment"===r.type){const t=r.value?.fields?.variant;t?.startsWith("plans")&&O(r.value,e),"mini"===t&&U(r.value,e)}})),e.body.placeholders={searchText:"{{coll-search-text}}",filtersText:"{{coll-filters-text}}",sortText:"{{coll-sort-text}}",popularityText:"{{coll-popularity-text}}",alphabeticallyText:"{{coll-alphabetically-text}}",noResultsText:"{{coll-no-results-text}}",plansSidenavTitle:"{{coll-plans-sidenav-title}}",resultText:"{{coll-result-text}}",resultsText:"{{coll-results-text}}",resultMobileText:"{{coll-result-mobile-text}}",resultsMobileText:"{{coll-results-mobile-text}}",searchResultText:"{{coll-search-result-text}}",searchResultsText:"{{coll-search-results-text}}",searchResultMobileText:"{{coll-search-result-mobile-text}}",searchResultsMobileText:"{{coll-search-results-mobile-text}}",noSearchResultsText:"{{coll-no-search-results-text}}",showMoreText:"{{coll-show-more-text}}"},e.dictionary={...e?.dictionary,"coll-filter":'<span data-placeholder=\\"filter\\"></span>',"coll-result-count":'<span data-placeholder=\\"resultCount\\"></span>',"coll-search-term":'<span data-placeholder=\\"searchTerm\\"></span>'}}(e),e}},I=["en_US","fr_FR","de_DE","es_ES","it_IT","pt_BR","nl_NL"];async function N(e,t,r,s){const{preview:a}=s,n=E(e,r,t,a),i=await $(n,s,"translate-id");if(200!=i.status)return{status:500,message:"translation search failed"};const{items:[{id:o}={}]}=i.body;if(o){const e=_(o,!0,a),t=await $(e,s,"translate-fragment");return 200!=t.status?{status:500,message:"translation search failed"}:{status:200,body:t.body}}return{status:404,message:"no translation found"}}const q={name:"translate",process:async function(e){const{body:t,locale:r}=e;let s,a,n,i=!1;const o=t?.path?.match(L);if(!o)return{status:400,message:"source path is either not here or invalid"};const{surface:l,parsedLocale:c,fragmentPath:u}=o.groups;if(r&&c!==r){const{body:t,status:o,message:f}=await N(l,u,r,e);if(s=t,a=o,n=f,404===a){const t=function(e){const[t]=e.split("_");for(const e of I)if(e.startsWith(t))return e;return e}(r);if(t!==r&&t!==c){i=!0,p(`no translation found for ${r}, trying default locale ${t}`,e);const{body:o,status:c,message:f}=await N(l,u,t,e);s=o,a=c,n=f}else t===c&&(a=200)}if(200!==a)return p(`translation failed: ${n}`,e),{status:a,message:n}}else p("no translation needed",e);return 200===a&&s&&!i&&(e.translatedId=s.id),{...e,status:a||200,body:s||t,surface:l,parsedLocale:c,fragmentPath:u}}},D=[{name:"fetchFragment",process:async function(e){const{id:t,locale:r,translatedId:s,preview:a}=e;if(t&&r){const r=_(s||t,!0,a),n=await $(r,e,"fragment");return 200==n.status?{...e,body:n.body}:async function(e){return{status:e.status,message:await h(e)}}(n)}return{...e,status:400,message:"requested parameters are not present"}}},q,F,S,T];async function M(e,t){const{locale:r="en_US",preview:s={url:"https://odinpreview.corp.adobe.com/adobe/sites/cf/fragments"}}=t;let a={id:e,status:200,preview:s,requestId:"preview",networkConfig:{mainTimeout:15e3,fetchTimeout:1e4,retries:3},api_key:"n/a",locale:r};for(const e of D)e.init&&(a.loggedTransformer=`${e.name}-init`,a.promises=a.promises||{},a.promises[e.name]=e.init(a));for(const e of D){if(200!=a.status){m(a.message,a);break}a.loggedTransformer=e.name,a=await e.process(a)}return 200!=a.status&&m(a.message,a),a.body}async function W(e,t){const{locale:r="en_US",preview:s={url:"https://odinpreview.corp.adobe.com/adobe/sites/cf/fragments"},dictionary:a,...n}=t;let i={body:e,status:200,preview:s,requestId:"preview",networkConfig:{mainTimeout:15e3,fetchTimeout:1e4,retries:3},api_key:"n/a",locale:r,dictionary:a,hasExternalDictionary:Boolean(a),...n};for(const e of[F,S,T]){if(200!=i.status){m(i.message,i);break}i.transformer=e.name,i=await e.process(i)}return 200!=i.status&&m(i.message,i),i.body}export{I as LANGUAGE_DEFAULTS,T as corrector,P as getDictionary,M as previewFragment,W as previewStudioFragment,S as replace,F as settings,q as translate};
//# sourceMappingURL=fragment-client.js.map
