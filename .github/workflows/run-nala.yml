name: Run Nala Tests

on:
    pull_request:
        branches:
            - main
        types: [opened, synchronize, labeled, unlabeled]

# Prevent multiple runs from happening at the same time
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    nala-gate:
        name: Nala Gate
        runs-on: ubuntu-latest
        outputs:
            run-nala: ${{ steps.check-should-run.outputs.should-run }}
        steps:
            - name: Check if tests should run
              id: check-should-run
              # Run tests when 'run nala' label is added, or
              # when 'run nala' exists on each PR open/synchronize
              run: |
                  LABELS="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
                  if [[ "${{ github.event.action }}" == "labeled" && "${{ github.event.label.name }}" == "run nala" ]] || \
                     ([[ "${{ github.event.action }}" == "opened" ]] && echo "$LABELS" | grep -q "run nala") || \
                     ([[ "${{ github.event.action }}" == "synchronize" ]] && echo "$LABELS" | grep -q "run nala"); then
                      echo "should-run=true" >> $GITHUB_OUTPUT
                  else
                      echo "should-run=false" >> $GITHUB_OUTPUT
                  fi
            - name: Require 'run nala' label
              # Run check for 'run nala' label always
              if: |
                  !contains(github.event.pull_request.labels.*.name, 'run nala')
              run: |
                  echo "::error::Add the 'run nala' label to merge this PR"
                  exit 1

    run-nala-studio-tests:
        name: Running Nala Studio E2E UI Tests
        needs: nala-gate
        if: needs.nala-gate.outputs.run-nala == 'true'
        runs-on: [self-hosted, Linux, X64]
        timeout-minutes: 30 # Prevent hanging jobs
        strategy:
            matrix:
                node-version: [20.x]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Set up Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'
                  cache-dependency-path: |
                      **/package-lock.json
                      **/yarn.lock

            - name: Install dependencies
              run: npm ci

            - name: Cache Playwright browsers
              uses: actions/cache@v4
              id: playwright-cache
              continue-on-error: true
              with:
                  path: ~/.cache/ms-playwright
                  key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/playwright.config.js') }}

            - name: Install Playwright system dependencies
              if: steps.playwright-cache.outputs.cache-hit != 'true'
              run: npx playwright install-deps

            - name: Install/verify Playwright browsers
              run: |
                  # Always run this - it's idempotent and fast when browsers are already correct
                  # It checks version compatibility and only installs if browsers are missing or outdated
                  npx playwright install

            - name: Set execute permission for gh.run.sh
              run: chmod +x ./nala/utils/gh.run.sh

            - name: Run Nala Studio Tests via gh.run.sh
              run: ./nala/utils/gh.run.sh
              env:
                  labels: "@mas-studio ${{ join(github.event.pull_request.labels.*.name, ' ') }}"
                  branch: ${{ github.event.pull_request.head.ref }}
                  repoName: ${{ github.repository }}
                  prUrl: ${{ github.event.pull_request.head.repo.html_url }}
                  prOrg: ${{ github.event.pull_request.head.repo.owner.login }}
                  prRepo: ${{ github.event.pull_request.head.repo.name }}
                  prBranch: ${{ github.event.pull_request.head.ref }}
                  prBaseBranch: ${{ github.event.pull_request.base.ref }}
                  GITHUB_ACTION_PATH: ${{ github.workspace }}
                  IMS_EMAIL: ${{ secrets.IMS_EMAIL }}
                  IMS_PASS: ${{ secrets.IMS_PASS }}
                  FORCE_COLOR: 3 # Force color output

            - name: Cleanup cloned cards
              if: always()
              run: node -e "
                  import('./nala/utils/global.teardown.js')
                  .then(module => module.default())
                  .catch(err => {
                  console.error('Cleanup failed:', err.message);
                  process.exit(1);
                  });"
              env:
                  GITHUB_ACTION_PATH: ${{ github.workspace }}
                  IMS_EMAIL: ${{ secrets.IMS_EMAIL }}
                  IMS_PASS: ${{ secrets.IMS_PASS }}

            - name: Upload screenshots
              uses: actions/upload-artifact@v4
              if: failure()
              with:
                  name: test-results-studio
                  path: test-results
                  retention-days: 7

    run-nala-docs-tests:
        name: Running Nala Docs E2E UI Tests
        needs: nala-gate
        if: needs.nala-gate.outputs.run-nala == 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 20 # Prevent hanging jobs
        strategy:
            matrix:
                node-version: [20.x]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Set up Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'
                  cache-dependency-path: |
                      **/package-lock.json
                      **/yarn.lock

            - name: Install dependencies
              run: npm ci

            - name: Cache Playwright browsers
              uses: actions/cache@v4
              id: playwright-cache
              continue-on-error: true
              with:
                  path: ~/.cache/ms-playwright
                  key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/playwright.config.js') }}

            - name: Install Playwright system dependencies
              if: steps.playwright-cache.outputs.cache-hit != 'true'
              run: npx playwright install-deps

            - name: Install/verify Playwright browsers
              run: |
                  # Always run this - it's idempotent and fast when browsers are already correct
                  # It checks version compatibility and only installs if browsers are missing or outdated
                  npx playwright install

            - name: Set execute permission for gh.run.sh
              run: chmod +x ./nala/utils/gh.run.sh

            - name: Run Nala Docs Tests via gh.run.sh
              run: ./nala/utils/gh.run.sh
              env:
                  labels: "@mas-docs ${{ join(github.event.pull_request.labels.*.name, ' ') }}"
                  branch: ${{ github.event.pull_request.head.ref }}
                  repoName: ${{ github.repository }}
                  prUrl: ${{ github.event.pull_request.head.repo.html_url }}
                  prOrg: ${{ github.event.pull_request.head.repo.owner.login }}
                  prRepo: ${{ github.event.pull_request.head.repo.name }}
                  prBranch: ${{ github.event.pull_request.head.ref }}
                  prBaseBranch: ${{ github.event.pull_request.base.ref }}
                  GITHUB_ACTION_PATH: ${{ github.workspace }}
                  FORCE_COLOR: 3 # Force color output

            - name: Upload screenshots
              uses: actions/upload-artifact@v4
              if: failure()
              with:
                  name: test-results-docs
                  path: test-results
                  retention-days: 7
