<!doctype html>
<html>
    <head>
        <script type="module">
            window.process = { env: {} };
            window.__swc = { warn: () => {} };

            // Set up fetch mock before any components are loaded
            const originalFetch = window.fetch;
            window.fetch = async function (args) {
                try {
                    const url = new URL(args);
                    const { pathname, search } = url;
                    const fullPath = pathname + search;

                    if (/querybuilder\.json\?path=\/content\/cq:tags\/mas/.test(fullPath)) {
                        return originalFetch('/test/mocks/tags.json');
                    }
                    if (/querybuilder\.json\?path=\/content\/dam\/mas/.test(fullPath)) {
                        return originalFetch('/test/mocks/folders.json');
                    }
                    return originalFetch(...arguments);
                } catch (e) {
                    return originalFetch(...arguments);
                }
            };
        </script>
        <title>merch-card-editor mnemonic tests</title>
        <meta name="nofollow-links" content="on" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="../../style.css" />
        <style>
            body {
                margin: 32px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            sp-theme {
                display: block;
                width: 100%;
            }
            mas-fragment-editor {
                display: block;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <script type="module">
            import { runTests } from '@web/test-runner-mocha';
            import { expect } from '@esm-bundle/chai';
            import { html } from 'lit';
            // Import actual components
            import '../../src/swc.js';
            import '../../src/rte/rte-field.js';
            import '../../src/aem/aem-tag-picker-field.js';
            import '../../src/mas-fragment-editor.js';
            import '../../src/mas-repository.js';
            // Import aem-fragment, mas-commerce-service, and merch-card from web-components
            import '../../../web-components/src/mas-commerce-service.js';
            import '../../../web-components/src/aem-fragment.js';
            import '../../../web-components/src/merch-card.js';
            // Import data classes
            import { Fragment } from '../../src/aem/fragment.js';
            import generateFragmentStore from '../../src/reactivity/source-fragment-store.js';
            import Store from '../../src/store.js';
            import { PAGE_NAMES } from '../../src/constants.js';
            import { delay } from '../utils.js';

            // Load the existing mock data for a merch card
            const baseMockData = await fetch('/test/mocks/adobe/sites/cf/fragments/cc-all-apps').then((res) => res.json());

            // Parent fragment (en_US default) with mnemonic - based on actual mock
            const parentFragmentData = {
                ...baseMockData,
                path: '/content/dam/mas/en_US/ccd-slice-cc-allapps',
                id: 'parent-fragment-id',
                fields: baseMockData.fields.map((field) => {
                    if (field.name === 'variant') {
                        return { ...field, values: ['plans'] };
                    }
                    if (field.name === 'mnemonicIcon') {
                        return { ...field, values: ['/test/mocks/img/creative-cloud.svg'] };
                    }
                    if (field.name === 'mnemonicAlt') {
                        return { ...field, values: ['Creative Cloud'] };
                    }
                    if (field.name === 'mnemonicLink') {
                        return { ...field, values: ['https://adobe.com'] };
                    }
                    return field;
                }),
            };

            // Variation fragment (de_DE) that inherits from parent - empty mnemonic fields = inherit
            const variationFragmentData = {
                ...baseMockData,
                path: '/content/dam/mas/de_DE/ccd-slice-cc-allapps',
                title: 'CCD Suggested CC All Apps (DE)',
                id: 'variation-fragment-id',
                fields: baseMockData.fields.map((field) => {
                    if (field.name === 'variant') {
                        return { ...field, values: ['plans'] };
                    }
                    if (field.name === 'mnemonicIcon') {
                        return { ...field, values: [] }; // Empty = inherit
                    }
                    if (field.name === 'mnemonicAlt') {
                        return { ...field, values: [] };
                    }
                    if (field.name === 'mnemonicLink') {
                        return { ...field, values: [] };
                    }
                    return field;
                }),
            };

            runTests(async () => {
                const spTheme = document.querySelector('sp-theme');

                describe('merch-card-editor', () => {
                    it('removes inherited mnemonic and restores it via override indicator', async () => {
                        // Create fragment and fragment store
                        const variationFragment = new Fragment(structuredClone(variationFragmentData));
                        const parentFragment = new Fragment(structuredClone(parentFragmentData));
                        const fragmentStore = generateFragmentStore(variationFragment, { skipAutoResolve: true });

                        // Set up Store - this is how mas-fragment-editor gets the fragment
                        Store.page.set(PAGE_NAMES.FRAGMENT_EDITOR);
                        Store.fragmentEditor.fragmentId.set('variation-fragment-id');
                        Store.fragments.inEdit.set(fragmentStore);
                        Store.fragments.list.data.set([fragmentStore]);

                        // Create mas-fragment-editor
                        const fragmentEditor = document.createElement('mas-fragment-editor');

                        // Mock repository methods before appending
                        const repository = document.querySelector('mas-repository');
                        repository.refreshFragment = async () => {};
                        repository.loadPreviewPlaceholders = async () => {};

                        // Mock editorContextStore before appending
                        fragmentEditor.editorContextStore = {
                            loadFragmentContext: async () => {},
                            isVariation: () => true,
                            getLocaleDefaultFragmentAsync: async () => structuredClone(parentFragmentData),
                            getDefaultLocaleId: () => 'parent-fragment-id',
                            getLocaleDefaultFragment: () => structuredClone(parentFragmentData),
                        };

                        // Set locale default fragment directly
                        fragmentEditor.localeDefaultFragment = parentFragment;
                        fragmentEditor.contextLoaded = true;
                        fragmentEditor.initializationComplete = true;

                        // Set up placeholders and surface for preview resolution
                        Store.placeholders.preview.set({});
                        Store.search.set((prev) => ({ ...prev, surface: 'web' }));

                        // Mark preview as resolved so it doesn't show skeleton
                        fragmentStore.previewStore.resolved = true;

                        // Populate aem-fragment cache with the fragment data for preview rendering
                        const AemFragment = customElements.get('aem-fragment');
                        if (AemFragment?.cache) {
                            AemFragment.cache.add(fragmentStore.previewStore.value);
                        }

                        // Append to DOM
                        spTheme.appendChild(fragmentEditor);

                        // Merge parent fields into preview store (simulates what initFragment does)
                        fragmentEditor.mergeEssentialParentFields();

                        await fragmentEditor.updateComplete;
                        await delay(500);

                        // Get the merch-card-editor inside mas-fragment-editor
                        const editor = fragmentEditor.querySelector('merch-card-editor');
                        expect(editor).to.exist;

                        // Wait for editor to be fully ready (fieldsReady = true)
                        while (!editor.fieldsReady) {
                            await editor.updateComplete;
                            await delay(50);
                        }

                        // Verify editor renders without skeleton
                        expect(editor.fieldsReady, 'Editor fieldsReady should be true').to.be.true;
                        const editorSkeleton = editor.querySelector('.editor-skeleton-wrapper');
                        const editorSkeletonDisplay = editorSkeleton
                            ? getComputedStyle(editorSkeleton).getPropertyValue('--skeleton-display')
                            : 'none';
                        expect(editorSkeletonDisplay.trim(), 'Editor should not show skeleton').to.equal('none');

                        // Verify preview renders without skeleton
                        const previewColumn = fragmentEditor.querySelector('#preview-column');
                        expect(previewColumn).to.exist;
                        const previewSkeleton = previewColumn.querySelector('.preview-skeleton');
                        expect(previewSkeleton, 'Preview should not show skeleton').to.be.null;
                        const merchCard = previewColumn.querySelector('merch-card');
                        expect(merchCard, 'Preview should render merch-card').to.exist;

                        // Step 1: Verify editor renders with inherited mnemonic
                        expect(editor.effectiveIsVariation).to.be.true;
                        expect(editor.getFieldState('mnemonicIcon')).to.equal('inherited');
                        expect(editor.mnemonics).to.have.length(1);
                        expect(editor.mnemonics[0].icon).to.equal('/test/mocks/img/creative-cloud.svg');

                        // Step 2: Find and click delete on the mnemonic field
                        const multifield = editor.querySelector('mas-multifield#mnemonics');
                        expect(multifield).to.exist;

                        const mnemonicField = multifield.shadowRoot.querySelector('mas-mnemonic-field');
                        expect(mnemonicField).to.exist;

                        // Simulate delete by dispatching the delete-field event
                        mnemonicField.dispatchEvent(new CustomEvent('delete-field', { bubbles: true, composed: true }));

                        await editor.updateComplete;
                        await delay(200);

                        // Step 3: Verify mnemonic is removed and state is overridden
                        expect(editor.getFieldState('mnemonicIcon')).to.equal('overridden');
                        expect(editor.mnemonics).to.have.length(0);
                        expect(editor.getEffectiveFieldValues('mnemonicIcon')).to.deep.equal([]);

                        // Step 4: Find and click "Overridden. Click to restore" link
                        const overrideIndicator = editor.querySelector('.field-status-indicator a');
                        expect(overrideIndicator).to.exist;
                        expect(overrideIndicator.textContent).to.include('Overridden');

                        overrideIndicator.click();

                        await editor.updateComplete;
                        await delay(200);

                        // Step 5: Verify mnemonic is restored from parent (inherits)
                        expect(editor.getFieldState('mnemonicIcon')).to.equal('inherited');
                        expect(editor.mnemonics).to.have.length(1);
                        expect(editor.mnemonics[0].icon).to.equal('/test/mocks/img/creative-cloud.svg');

                        // DOM is preserved - do not remove editor
                    });
                });
            });
        </script>
        <mas-commerce-service env="stage"></mas-commerce-service>
        <mas-repository base-url="http://localhost:2023/test/mocks"></mas-repository>
        <sp-theme system="spectrum-two" color="light" scale="medium"></sp-theme>
    </body>
</html>
