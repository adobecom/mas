var e,t,s,n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},r={exports:{}};e=r,t=r.exports,s=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==n)return n;throw new Error("unable to locate global object")}(),e.exports=t=s.fetch,s.fetch&&(t.default=s.fetch.bind(s)),t.Headers=s.Headers,t.Request=s.Request,t.Response=s.Response;var a=r.exports;const o=["cards","collections","entries"],i=[...o,"tags"];function l(e){const{fields:t,references:s}=e,n={};s&&s.forEach((e=>{const{type:t,path:s,id:r}=e;"content-fragment"===t&&(n[s]=r)}));const r=t.reduce(((e,{name:t,multiple:s,values:r,mimeType:a})=>(o.includes(t)?e[t]=r.map((e=>"string"==typeof e&&n[e]||e)):e[t]="text/html"===a?{mimeType:a,value:r[0]}:s?r:r[0],e)),{});return r}function c(e,t){if(!e)return[];const s=[];for(const[n,r]of Object.entries(e))i.includes(n)&&Array.isArray(r)&&r.forEach((e=>{if(t[e]){const r={fieldName:n,identifier:e,referencesTree:[]},a=t[e];"content-fragment"===a.type&&(r.referencesTree=c(a.value.fields,t)),s.push(r)}}));return s}function u(e){if(!e.references)return e;const t=(e,s)=>{const n=l(s);s.references&&s.references.length>0&&s.references.forEach((s=>{Object.keys(e).find((e=>e===s.id))||t(e,s)})),e[s.id]={type:s.type,value:{name:s.name||"",title:s.title||"",description:s.description||"",path:s.path||"",id:s.id,model:{id:s.model?.id},fields:n}},s.tags&&Array.isArray(s.tags)&&s.tags.forEach((t=>{t&&t.id&&!e[t.id]&&(e[t.id]={type:"tag",value:{id:t.id,name:t.name||"",title:t.title||"",path:t.path||"",description:void 0!==t.description?t.description:null,i18n:t.i18n||[],titlePath:t.titlePath||""}})}))};return e.references&&(e.references=e.references.reduce(((e,s)=>(t(e,s),e)),{}),e.referencesTree=c(e.fields,e.references)),e}var d={transformBody:function(e){return e.fields=l(e),e=u(e)}};const f=a,{transformBody:p}=d;function h(e,t="info"){return`[${t}][${e.api_key}][${e.requestId}][${e.transformer}]`}function y(e,t){console.log(`${h(t)} ${e}`)}function g(e,t){console.error(`${h(t,"error")} ${e}`)}function m(e,t){t.debugLogs&&console.log(`${h(t,"debug")} ${e()}`)}async function b(e){let t="nok";try{const s=await e.json();t=s?.detail}catch(e){}return t}async function w(e,t){let s=await e.json();return t.preview&&Array.isArray(s.fields)&&(y("massaging old school schema for preview",t),s=p(s)),s}var x={fetch:async function(e,t){try{const s=Date.now(),n=await f(e,{headers:t.DEFAULT_HEADERS}),r=200==n.status,a=r?"ok":await b(n);return y(`fetch ${e} (${n?.status}) ${a} in ${Date.now()-s}ms`,t),m((()=>`response headers: ${JSON.stringify(Object.fromEntries(n.headers.entries()))}`),t),200===n.status?{status:200,body:await w(n,t)}:n}catch(s){g(`[fetch] ${e} fetch error: ${s.message}`,t)}return{...t,status:500,message:"fetch error"}},getErrorContext:async function(e){return{status:e.status,message:await b(e)}},log:y,logDebug:m,logError:g};const v="/content/dam/mas",T="https://odin.adobe.com/adobe/sites/fragments";function $(e){return`${e?.url?e.url:T}`}function R(e,t){return`${$(t)}/${e}`}var E={PATH_TOKENS:/\/content\/dam\/mas\/(?<surface>[\w-_]+)\/(?<parsedLocale>[\w-_]+)\/(?<fragmentPath>.+)/,FRAGMENT_URL_PREFIX:T,MAS_ROOT:v,odinPath:function(e,t,s,n){return`${$(n)}?path=${v}/${e}/${t}/${s}`},odinId:R,odinReferences:function(e,t=!1,s){return`${R(e,s)}${t?"?references=all-hydrated":""}`}};const{fetch:_,getErrorContext:L}=x,{odinReferences:P}=E;var S=async function(e){const{id:t,locale:s,translatedId:n,preview:r}=e;if(t&&s){const s=P(n||t,!0,r),a=await _(s,e);return 200==a.status?{...e,body:a.body}:L(a)}return{...e,status:400,message:"requested parameters are not present"}};const{PATH_TOKENS:A,odinPath:O,odinReferences:j}=E,{fetch:k,log:N}=x,I=["en_US","fr_FR","de_DE","es_ES","it_IT","pt_BR","nl_NL"];async function F(e,t,s,n){const{preview:r}=n,a=O(e,s,t,r),o=await k(a,n);if(200!=o.status)return{status:500,message:"translation search failed"};const{items:[{id:i}={}]}=o.body;if(i){const e=j(i,!0,r),t=await k(e,n);return 200!=t.status?{status:500,message:"translation search failed"}:{status:200,body:t.body}}return{status:404,message:"no translation found"}}getCorrespondingLocale=e=>{const[t]=e.split("_");for(const e of I)if(e.startsWith(t))return e;return e};var D=async function(e){const{body:t,locale:s}=e;let n,r,a,o=!1;const i=t?.path?.match(A);if(!i)return{status:400,message:"source path is either not here or invalid"};const{surface:l,parsedLocale:c,fragmentPath:u}=i.groups;if(s&&c!==s){const{body:t,status:i,message:d}=await F(l,u,s,e);if(n=t,r=i,a=d,404===r){const t=getCorrespondingLocale(s);if(t!==s&&t!==c){o=!0,N(`no translation found for ${s}, trying default locale ${t}`,e);const{body:i,status:c,message:d}=await F(l,u,t,e);n=i,r=c,a=d}}if(200!==r)return N(`translation failed: ${a}`,e),{status:r,message:a}}else N("no translation needed",e);return 200===r&&n&&!o&&(e.translatedId=n.id),{...e,status:r||200,body:n||t,surface:l,parsedLocale:c,fragmentPath:u}};const{odinReferences:M,odinPath:H}=E,{fetch:W,log:q,logDebug:C,logError:U}=x,z=/{{(\s*([\w\-\_]+)\s*)}}/gi;async function B(e){const t=e.dictionary||{},s=e.dictionaryId??await async function(e){const{surface:t,locale:s,preview:n}=e,r=H(t,s,"dictionary/index",n),a=await W(r,e);if(200==a.status){const{items:t}=a.body;if(t?.length>0){const s=t[0].id;return e.dictionaryId=s,s}}return null}(e);if(!s)return t;const n=await W(M(s,!0,e.preview),e);if(200==n.status){const e=n.body.references;return Object.keys(e).forEach((s=>{const n=e[s]?.value?.fields;n?.key&&(t[n.key]=function(e){return(e.value||e.richTextValue?.value||"").replace(/[\u0000-\u001F\u007F-\u009F]/g,"").replace(/"/g,'\\"')}(n))})),t}return t}function J(e,t,s){const n=e.matchAll(z);let r="",a=0;for(const o of n){const n=o[1];r+=e.slice(a,o.index);let i=null==t[n]||s.includes(n)?n:t[n];i?.match(z)&&(s.push(n),i=J(i,t,s),s.pop()),r+=i,a=o.index+o[0].length}return r+=e.slice(a),r}var G=async function(e){let t=e.body,s=JSON.stringify(t);if(s.match(z)){const n=await B(e);if(n&&Object.keys(n).length>0){s=J(s,n,[]);try{t=JSON.parse(s)}catch(t){U(`[replace] ${t.message}`,e),C((()=>`[replace] invalid json: ${s}`),e)}}}else q("no placeholders found in fragment content",e);return{...e,status:200,body:t}};function K(e,t){e.settings={},!1!==e?.fields?.showSecureLabel&&(e.settings.secureLabel="{{secure-label}}"),null!=e?.fields?.showPlanType&&(e.settings.displayPlanType=e?.fields?.showPlanType),"en_US"===t&&(e.settings.displayPlanType??=!0)}var Y=async function(e){const{locale:t}=e;return e.body?.fields?.variant?.startsWith("plans")&&K(e.body,t),"L2NvbmYvbWFzL3NldHRpbmdzL2RhbS9jZm0vbW9kZWxzL2NvbGxlY3Rpb24"===e.body?.model?.id&&function(e){e.body.placeholders={searchText:"{{coll-search-text}}",filtersText:"{{coll-filters-text}}",sortText:"{{coll-sort-text}}",popularityText:"{{coll-popularity-text}}",alphabeticallyText:"{{coll-alphabetically-text}}",noResultsText:"{{coll-no-results-text}}",plansSidenavTitle:"{{coll-plans-sidenav-title}}",resultText:"{{coll-result-text}}",resultsText:"{{coll-results-text}}",resultMobileText:"{{coll-result-mobile-text}}",resultsMobileText:"{{coll-results-mobile-text}}",searchResultText:"{{coll-search-result-text}}",searchResultsText:"{{coll-search-results-text}}",searchResultMobileText:"{{coll-search-result-mobile-text}}",searchResultsMobileText:"{{coll-search-results-mobile-text}}",noSearchResultsText:"{{coll-no-search-results-text}}",showMoreText:"{{coll-show-more-text}}"},e.dictionary={...e?.dictionary,"coll-filter":'<span data-placeholder=\\"filter\\"></span>',"coll-result-count":'<span data-placeholder=\\"resultCount\\"></span>',"coll-search-term":'<span data-placeholder=\\"searchTerm\\"></span>'}}(e),e.body?.references&&Object.entries(e.body.references).forEach((([e,s])=>{s&&"content-fragment"===s.type&&s.value?.fields?.variant?.startsWith("plans")&&K(s.value,t)})),e};async function Z(e,t){const{locale:s="en_US",preview:n={url:"https://odinpreview.corp.adobe.com/adobe/sites/cf/fragments"}}=t;let r={id:e,status:200,preview:n,requestId:"preview",api_key:"n/a",locale:s};for(const e of[S,D,Y,G]){if(200!=r.status){x.logError(r.message,r);break}r.transformer=e.name,r=await e(r)}return 200!=r.status&&x.logError(r.message,r),r.body}export{Z as previewFragment};
//# sourceMappingURL=fragment-client.js.map
