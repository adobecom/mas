var e,t,n,s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},r={exports:{}};e=r,t=r.exports,n=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==s)return s;throw new Error("unable to locate global object")}(),e.exports=t=n.fetch,n.fetch&&(t.default=n.fetch.bind(n)),t.Headers=n.Headers,t.Request=n.Request,t.Response=n.Response;const a=r.exports;function o(e,t="info"){return`[${t}][${e.api_key}][${e.requestId}][${e.transformer}]`}function c(e,t){console.log(`${o(t)} ${e}`)}function i(e,t){console.error(`${o(t,"error")} ${e}`)}function f(e,t){t.debugLogs&&console.log(`${o(t,"debug")} ${e()}`)}async function u(e){let t="nok";try{const n=await e.json();t=n?.detail}catch(e){}return t}async function l(e,t){let n=await e.json();if(t.preview&&"array"==typeof n.fields){c("massaging old school schema for preview",t);const{fields:e,id:s,tags:r}=n;n=e.reduce(((e,{name:t,multiple:n,values:s})=>(e.fields[t]=n?s:s[0],e)),{fields:{},id:s,tags:r})}return n}var d={fetch:async function(e,t){try{const n=Date.now(),s=await a(e,{headers:t.DEFAULT_HEADERS}),r=200==s.status,o=r?"ok":await u(s);return c(`fetch ${e} (${s?.status}) ${o} in ${Date.now()-n}ms`,t),f((()=>`response headers: ${JSON.stringify(Object.fromEntries(s.headers.entries()))}`),t),200===s.status?{status:200,body:await l(s,t)}:s}catch(n){i(`[fetch] ${e} fetch error: ${n.message}`,t)}return{...t,status:500,message:"fetch error"}},getErrorContext:async function(e){return{status:e.status,message:await u(e)}},log:c,logDebug:f,logError:i};const y="/content/dam/mas",g="https://odin.adobe.com/adobe/sites/fragments";function p(e){return`${e?.url?e.url:g}`}function b(e,t){return`${p(t)}/${e}`}var h={PATH_TOKENS:/\/content\/dam\/mas\/(?<surface>[\w-_]+)\/(?<parsedLocale>[\w-_]+)\/(?<fragmentPath>.+)/,FRAGMENT_URL_PREFIX:g,MAS_ROOT:y,odinPath:function(e,t,n,s){return`${p(s)}?path=${y}/${e}/${t}/${n}`},odinId:b,odinReferences:function(e,t=!1,n){return`${b(e,n)}${t?"?references=all-hydrated":""}`}};const{fetch:w,getErrorContext:m}=d,{odinReferences:$}=h;var v=async function(e){const{id:t,locale:n,translatedId:s,preview:r}=e;if(t&&n){const n=$(s||t,!0,r),a=await w(n,e);return 200==a.status?{...e,body:a.body}:m(a)}return{...e,status:400,message:"requested parameters are not present"}};const{odinReferences:E,odinPath:k}=h,{fetch:x,log:O,logError:R}=d,_=/{{(\s*([\w\-]+)\s*)}}/gi;async function I(e){const t=e.dictionaryId||await async function(e){const{surface:t,locale:n,preview:s}=e,r=k(t,n,"dictionary/index",s),a=await x(r,e);if(200==a.status){const{items:t}=a.body;if(t?.length>0){const n=t[0].id;return e.dictionaryId=n,n}}return null}(e);if(!t)return null;const n=await x(E(t,!0,e.preview),e);if(200==n.status){const e=n.body.references,t={};return Object.keys(e).forEach((n=>{const s=e[n]?.value?.fields;s?.key&&(t[s.key]=function(e){return(e.value||e?.richTextValue?.value||"").replace(/[\u0000-\u001F\u007F-\u009F]/g,"")}(s))})),t}return null}function S(e,t,n){const s=e.matchAll(_);let r="",a=0;for(const o of s){const s=o[1];r+=e.slice(a,o.index);let c=null==t[s]||n.includes(s)?s:t[s];c.match(_)&&(n.push(s),c=S(c,t,n),n.pop()),r+=c,a=o.index+o[0].length}return r+=e.slice(a),r}var T=async function(e){let t=e.body,n=JSON.stringify(t);if(n.match(_)){const s=await I(e);if(s&&Object.keys(s).length>0){n=S(n,s,[]);try{t=JSON.parse(n)}catch(t){R(`[replace] ${t.message}`,e)}}}else O("no placeholders found in fragment content",e);return{...e,status:200,body:t}};function j(e,t){e.settings={stockCheckboxLabel:"{{stock-checkbox-label}}",stockOfferOsis:""},"en_US"===t&&(e.settings.displayPlanType=!0),!1!==e?.fields?.showSecureLabel&&(e.settings.secureLabel="{{secure-label}}")}var L=async function(e){const{locale:t}=e;return"plans"===e.body?.fields?.variant&&j(e.body,t),e.body?.references&&Object.entries(e.body.references).forEach((([e,n])=>{n&&"content-fragment"===n.type&&"plans"===n.value?.fields?.variant&&j(n.value,t)})),e};async function A(e,t){const{surface:n,locale:s="en_US",preview:r={url:"https://odinpreview.corp.adobe.com/adobe/sites/cf/fragments"}}=t;let a={id:e,status:200,preview:r,requestId:"preview",api_key:"n/a",translatedId:e,dictionaryId:{acom:"412fda08-7b73-4a01-a04f-1953e183bad2",sandbox:"4218bdb3-8d25-4706-974d-21b1f0f13aa9",nala:"1cdf7301-3d14-46e6-8ee8-0f06841ad5af"}[n],locale:s};for(const e of[v,L,T]){if(200!=a.status){d.logError(a.message,a);break}a.transformer=e.name,a=await e(a)}return 200!=a.status&&d.logError(a.message,a),a.body}export{A as previewFragment};
//# sourceMappingURL=fragment-client.js.map
