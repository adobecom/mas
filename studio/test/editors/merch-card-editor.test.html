<!doctype html>
<html>
    <head>
        <script type="module">
            window.process = { env: {} };
            window.__swc = { warn: () => {} };

            // Set up fetch mock before any components are loaded
            const originalFetch = window.fetch;
            // Load offers for WCS mock
            const offersPromise = originalFetch('/test/mocks/offers.json').then((r) => r.json());

            window.fetch = async function (args) {
                try {
                    const url = new URL(args);
                    const { pathname, search } = url;
                    const fullPath = pathname + search;

                    if (/querybuilder\.json\?path=\/content\/cq:tags\/mas/.test(fullPath)) {
                        return originalFetch('/test/mocks/tags.json');
                    }
                    if (/querybuilder\.json\?path=\/content\/dam\/mas/.test(fullPath)) {
                        return originalFetch('/test/mocks/folders.json');
                    }
                    // Mock WCS offer fetch
                    if (pathname.includes('web_commerce_artifact')) {
                        const offers = await offersPromise;
                        const osi = url.searchParams.get('offer_selector_ids');
                        const language = url.searchParams.get('language')?.toLowerCase() || 'mult';
                        const offerKey = `${osi}-${language}`;
                        const offerData = offers[offerKey] || offers[osi];
                        if (offerData) {
                            return new Response(
                                JSON.stringify({
                                    resolvedOffers: offerData.map((offer) => ({
                                        ...offer,
                                        offerSelectorIds: [osi],
                                    })),
                                }),
                                { status: 200, headers: { 'Content-Type': 'application/json' } },
                            );
                        }
                        return new Response(JSON.stringify({ error: 'Not found' }), { status: 404 });
                    }
                    return originalFetch(...arguments);
                } catch (e) {
                    return originalFetch(...arguments);
                }
            };
        </script>
        <title>merch-card-editor mnemonic tests</title>
        <meta name="nofollow-links" content="on" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="../../style.css" />
        <style>
            body {
                margin: 32px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            sp-theme {
                display: block;
                width: 100%;
            }
            mas-fragment-editor {
                display: block;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <script type="module">
            import { runTests } from '@web/test-runner-mocha';
            import { expect } from '@esm-bundle/chai';
            import { html } from 'lit';
            // Import actual components
            import '../../src/swc.js';
            import '../../src/rte/rte-field.js';
            import '../../src/aem/aem-tag-picker-field.js';
            import '../../src/mas-fragment-editor.js';
            import '../../src/mas-repository.js';
            // Import aem-fragment, mas-commerce-service, and merch-card from web-components
            import '../../../web-components/src/mas-commerce-service.js';
            import '../../../web-components/src/aem-fragment.js';
            import '../../../web-components/src/merch-card.js';
            // Import data classes
            import { Fragment } from '../../src/aem/fragment.js';
            import generateFragmentStore from '../../src/reactivity/source-fragment-store.js';
            import Store from '../../src/store.js';
            import { PAGE_NAMES } from '../../src/constants.js';
            import { delay } from '../utils.js';

            // Load the existing mock data for a merch card
            const baseMockData = await fetch('/test/mocks/adobe/sites/cf/fragments/cc-all-apps').then((res) => res.json());

            // Parent fragment (en_US default) with mnemonic - based on actual mock
            const parentFragmentData = {
                ...baseMockData,
                path: '/content/dam/mas/en_US/ccd-slice-cc-allapps',
                id: 'parent-fragment-id',
                fields: baseMockData.fields.map((field) => {
                    if (field.name === 'variant') {
                        return { ...field, values: ['plans'] };
                    }
                    if (field.name === 'mnemonicIcon') {
                        return { ...field, values: ['/test/mocks/img/creative-cloud.svg'] };
                    }
                    if (field.name === 'mnemonicAlt') {
                        return { ...field, values: ['Creative Cloud'] };
                    }
                    if (field.name === 'mnemonicLink') {
                        return { ...field, values: ['https://adobe.com'] };
                    }
                    return field;
                }),
            };

            // Variation fragment (en_AU) that inherits from parent - empty mnemonic fields = inherit
            const variationFragmentData = {
                ...baseMockData,
                path: '/content/dam/mas/en_AU/ccd-slice-cc-allapps',
                title: 'CCD Suggested CC All Apps (AU)',
                id: 'variation-fragment-id',
                fields: baseMockData.fields.map((field) => {
                    if (field.name === 'variant') {
                        return { ...field, values: ['plans'] };
                    }
                    if (field.name === 'mnemonicIcon') {
                        return { ...field, values: [] }; // Empty = inherit
                    }
                    if (field.name === 'mnemonicAlt') {
                        return { ...field, values: [] };
                    }
                    if (field.name === 'mnemonicLink') {
                        return { ...field, values: [] };
                    }
                    return field;
                }),
            };

            runTests(async () => {
                const spTheme = document.querySelector('sp-theme');

                describe('merch-card-editor', () => {
                    it('removes inherited mnemonic and restores it via override indicator', async () => {
                        console.log('[TEST] Starting test...');

                        // Create fragment and fragment store with parent (new API)
                        const variationFragment = new Fragment(structuredClone(variationFragmentData));
                        const parentFragment = new Fragment(structuredClone(parentFragmentData));
                        // Pass parentFragment as second argument - this merges parent values into preview
                        const fragmentStore = generateFragmentStore(variationFragment, parentFragment);
                        console.log('[TEST] Created fragments and store with parent');

                        // Set up Store - this is how mas-fragment-editor gets the fragment
                        Store.page.set(PAGE_NAMES.FRAGMENT_EDITOR);
                        Store.fragmentEditor.fragmentId.set('variation-fragment-id');
                        Store.fragments.inEdit.set(fragmentStore);
                        Store.fragments.list.data.set([fragmentStore]);
                        console.log('[TEST] Store configured');

                        // Create mas-fragment-editor
                        const fragmentEditor = document.createElement('mas-fragment-editor');
                        console.log('[TEST] Created mas-fragment-editor element');

                        // Mock repository methods before appending
                        const repository = document.querySelector('mas-repository');
                        repository.refreshFragment = async () => {};
                        repository.loadPreviewPlaceholders = async () => {};
                        console.log('[TEST] Mocked repository methods');

                        // Mock editorContextStore before appending
                        fragmentEditor.editorContextStore = {
                            loadFragmentContext: async () => {},
                            isVariation: () => true,
                            getLocaleDefaultFragmentAsync: async () => structuredClone(parentFragmentData),
                            getDefaultLocaleId: () => 'parent-fragment-id',
                            getLocaleDefaultFragment: () => structuredClone(parentFragmentData),
                        };
                        console.log('[TEST] Mocked editorContextStore');

                        // Set locale default fragment directly
                        fragmentEditor.localeDefaultFragment = parentFragment;
                        fragmentEditor.initState = 'ready';
                        console.log('[TEST] Set locale default fragment and init state');

                        // Set up placeholders and surface for preview resolution
                        Store.placeholders.preview.set({});
                        Store.search.set((prev) => ({ ...prev, surface: 'web' }));
                        console.log('[TEST] Set placeholders and surface');

                        // Mark preview as resolved so it doesn't show skeleton
                        fragmentStore.previewStore.resolved = true;
                        console.log('[TEST] Marked preview as resolved');

                        // Populate aem-fragment cache with the fragment data for preview rendering
                        const AemFragment = customElements.get('aem-fragment');
                        if (AemFragment?.cache) {
                            AemFragment.cache.add(fragmentStore.previewStore.value);
                        }
                        console.log('[TEST] Populated aem-fragment cache');

                        // Append to DOM
                        spTheme.appendChild(fragmentEditor);
                        console.log('[TEST] Appended fragmentEditor to DOM');

                        await fragmentEditor.updateComplete;
                        await delay(500);
                        console.log('[TEST] Waited for fragmentEditor.updateComplete');

                        // Get the merch-card-editor inside mas-fragment-editor
                        const editor = fragmentEditor.querySelector('merch-card-editor');
                        console.log('[TEST] Found merch-card-editor:', !!editor);
                        expect(editor).to.exist;

                        // Verify preview renders without skeleton
                        const previewColumn = fragmentEditor.querySelector('#preview-column');
                        expect(previewColumn).to.exist;
                        const previewSkeleton = previewColumn.querySelector('.preview-skeleton');
                        expect(previewSkeleton, 'Preview should not show skeleton').to.be.null;
                        const merchCard = previewColumn.querySelector('merch-card');
                        expect(merchCard, 'Preview should render merch-card').to.exist;

                        // Step 1: Verify editor renders with inherited mnemonic
                        expect(editor.effectiveIsVariation).to.be.true;
                        expect(editor.getFieldState('mnemonicIcon')).to.equal('inherited');
                        expect(editor.mnemonics).to.have.length(1);
                        expect(editor.mnemonics[0].icon).to.equal('/test/mocks/img/creative-cloud.svg');

                        // Step 2: Find and click delete on the mnemonic field
                        const multifield = editor.querySelector('mas-multifield#mnemonics');
                        expect(multifield).to.exist;

                        const mnemonicField = multifield.shadowRoot.querySelector('mas-mnemonic-field');
                        expect(mnemonicField).to.exist;

                        // Simulate delete by dispatching the delete-field event
                        mnemonicField.dispatchEvent(new CustomEvent('delete-field', { bubbles: true, composed: true }));

                        await editor.updateComplete;
                        await delay(200);

                        // Step 3: Verify mnemonic is removed and state is overridden
                        expect(editor.getFieldState('mnemonicIcon')).to.equal('overridden');
                        expect(editor.mnemonics).to.have.length(0);
                        expect(editor.getEffectiveFieldValues('mnemonicIcon')).to.deep.equal([]);

                        // Step 4: Find and click "Overridden. Click to restore" link
                        const overrideIndicator = editor.querySelector('.field-status-indicator a');
                        expect(overrideIndicator).to.exist;
                        expect(overrideIndicator.textContent).to.include('Overridden');

                        overrideIndicator.click();

                        await editor.updateComplete;
                        await delay(200);

                        // Step 5: Verify mnemonic is restored from parent (inherits)
                        expect(editor.getFieldState('mnemonicIcon')).to.equal('inherited');
                        expect(editor.mnemonics).to.have.length(1);
                        expect(editor.mnemonics[0].icon).to.equal('/test/mocks/img/creative-cloud.svg');

                        // DOM is preserved - do not remove editor
                    });
                });

                describe('description field inheritance', () => {
                    it('source store keeps raw variation data, preview store has parent-merged data', async () => {
                        // Parent fragment with description content
                        const parentWithDescription = {
                            ...baseMockData,
                            path: '/content/dam/mas/nala/en_US/parent-card',
                            id: 'parent-with-description',
                            fields: baseMockData.fields.map((field) => {
                                if (field.name === 'variant') {
                                    return { ...field, values: ['plans'] };
                                }
                                if (field.name === 'description') {
                                    return { ...field, values: ['<p>Parent description content</p>'], multiple: false };
                                }
                                return field;
                            }),
                        };

                        // Variation with empty description (should inherit from parent)
                        const variationWithEmptyDescription = {
                            ...baseMockData,
                            path: '/content/dam/mas/nala/en_AU/parent-card',
                            id: 'variation-with-empty-description',
                            fields: baseMockData.fields.map((field) => {
                                if (field.name === 'variant') {
                                    return { ...field, values: ['plans'] };
                                }
                                if (field.name === 'description') {
                                    return { ...field, values: [], multiple: false }; // Empty = inherit
                                }
                                return field;
                            }),
                        };

                        const variationFragment = new Fragment(structuredClone(variationWithEmptyDescription));
                        const parentFragment = new Fragment(structuredClone(parentWithDescription));

                        // Create store with parent for variation
                        const store = generateFragmentStore(variationFragment, parentFragment);

                        // SOURCE store should have the RAW variation data (empty description)
                        const sourceDescValues = store.value.getFieldValues('description');
                        expect(sourceDescValues, 'Source should have empty description (raw variation data)').to.deep.equal([]);

                        // PREVIEW store should have PARENT-MERGED data (parent's description)
                        const previewDescValues = store.previewStore.value.getFieldValues('description');
                        expect(previewDescValues, 'Preview should have parent description (merged for display)').to.deep.equal([
                            '<p>Parent description content</p>',
                        ]);

                        // Verify field state is 'inherited'
                        const fieldState = store.value.getFieldState('description', parentFragment, true);
                        expect(fieldState, 'Description field state should be inherited').to.equal('inherited');

                        // Verify source and preview don't share references
                        const sourceField = store.value.getField('description');
                        const previewField = store.previewStore.value.getField('description');
                        expect(sourceField, 'Source and preview fields should be different objects').to.not.equal(previewField);
                    });

                    it('source store is not contaminated after preview resolution', async () => {
                        // Parent fragment with description content
                        const parentWithDescription = {
                            ...baseMockData,
                            path: '/content/dam/mas/nala/en_US/parent-card-2',
                            id: 'parent-with-description-2',
                            fields: baseMockData.fields.map((field) => {
                                if (field.name === 'variant') {
                                    return { ...field, values: ['plans'] };
                                }
                                if (field.name === 'description') {
                                    return { ...field, values: ['<p>Parent description</p>'], multiple: false };
                                }
                                return field;
                            }),
                        };

                        // Variation with empty description
                        const variationWithEmptyDescription = {
                            ...baseMockData,
                            path: '/content/dam/mas/nala/en_AU/parent-card-2',
                            id: 'variation-with-empty-description-2',
                            fields: baseMockData.fields.map((field) => {
                                if (field.name === 'variant') {
                                    return { ...field, values: ['plans'] };
                                }
                                if (field.name === 'description') {
                                    return { ...field, values: [], multiple: false };
                                }
                                return field;
                            }),
                        };

                        const variationFragment = new Fragment(structuredClone(variationWithEmptyDescription));
                        const parentFragment = new Fragment(structuredClone(parentWithDescription));

                        const store = generateFragmentStore(variationFragment, parentFragment);

                        // Simulate what preview resolution does - modify preview store
                        store.previewStore.value.getField('description').values = ['<p>Resolved preview content</p>'];

                        // SOURCE store should STILL have empty description (not contaminated)
                        const sourceDescValues = store.value.getFieldValues('description');
                        expect(sourceDescValues, 'Source should remain empty after preview modification').to.deep.equal([]);

                        // Source initialValue should also be clean
                        const initialDescField = store.value.initialValue.fields.find((f) => f.name === 'description');
                        expect(initialDescField.values, 'Source initialValue should have empty description').to.deep.equal([]);
                    });

                    it('[""] on single-value field is treated as inherited', async () => {
                        // Parent fragment with description content
                        const parentWithDescription = {
                            ...baseMockData,
                            path: '/content/dam/mas/nala/en_US/parent-card-3',
                            id: 'parent-with-description-3',
                            fields: baseMockData.fields.map((field) => {
                                if (field.name === 'variant') {
                                    return { ...field, values: ['plans'] };
                                }
                                if (field.name === 'description') {
                                    return { ...field, values: ['<p>Parent description</p>'], multiple: false };
                                }
                                return field;
                            }),
                        };

                        // Variation with [""] description (AEM's default for empty single-value fields)
                        const variationWithEmptyStringDescription = {
                            ...baseMockData,
                            path: '/content/dam/mas/nala/en_AU/parent-card-3',
                            id: 'variation-with-empty-string-description',
                            fields: baseMockData.fields.map((field) => {
                                if (field.name === 'variant') {
                                    return { ...field, values: ['plans'] };
                                }
                                if (field.name === 'description') {
                                    return { ...field, values: [''], multiple: false }; // [""] = AEM default, should inherit
                                }
                                return field;
                            }),
                        };

                        const variationFragment = new Fragment(structuredClone(variationWithEmptyStringDescription));
                        const parentFragment = new Fragment(structuredClone(parentWithDescription));

                        // Field state should be 'inherited' for [""] on single-value fields
                        const fieldState = variationFragment.getFieldState('description', parentFragment, true);
                        expect(fieldState, '[""] on single-value field should be inherited').to.equal('inherited');

                        // Effective values should come from parent
                        const effectiveValues = variationFragment.getEffectiveFieldValues('description', parentFragment, true);
                        expect(effectiveValues, 'Effective values should be parent description').to.deep.equal([
                            '<p>Parent description</p>',
                        ]);
                    });

                    it('[""] on field without explicit multiple property is treated as inherited', async () => {
                        // This test reproduces the actual AEM response where multiple may be undefined
                        const parentWithDescription = {
                            ...baseMockData,
                            path: '/content/dam/mas/nala/en_US/parent-card-4',
                            id: 'parent-with-description-4',
                            fields: baseMockData.fields.map((field) => {
                                if (field.name === 'variant') {
                                    return { ...field, values: ['plans'] };
                                }
                                if (field.name === 'description') {
                                    // Don't set multiple - let it be whatever AEM sends (false or undefined)
                                    return { ...field, values: ['<p>Parent description</p>'] };
                                }
                                return field;
                            }),
                        };

                        // Variation with [""] description - don't explicitly set multiple
                        const variationWithEmptyStringDescription = {
                            ...baseMockData,
                            path: '/content/dam/mas/nala/en_AU/parent-card-4',
                            id: 'variation-with-empty-string-description-4',
                            fields: baseMockData.fields.map((field) => {
                                if (field.name === 'variant') {
                                    return { ...field, values: ['plans'] };
                                }
                                if (field.name === 'description') {
                                    // Don't set multiple - let it be whatever AEM sends
                                    return { ...field, values: [''] };
                                }
                                return field;
                            }),
                        };

                        const variationFragment = new Fragment(structuredClone(variationWithEmptyStringDescription));
                        const parentFragment = new Fragment(structuredClone(parentWithDescription));

                        // Field state should be 'inherited' for [""] when multiple is false or undefined
                        const fieldState = variationFragment.getFieldState('description', parentFragment, true);
                        expect(fieldState, '[""] on field without explicit multiple should be inherited').to.equal('inherited');
                    });
                });
            });
        </script>
        <mas-commerce-service env="stage"></mas-commerce-service>
        <mas-repository base-url="http://localhost:2023/test/mocks"></mas-repository>
        <sp-theme system="spectrum-two" color="light" scale="medium"></sp-theme>
    </body>
</html>
