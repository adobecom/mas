var e,t,s,r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n={exports:{}};e=n,t=n.exports,s=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==r)return r;throw new Error("unable to locate global object")}(),e.exports=t=s.fetch,s.fetch&&(t.default=s.fetch.bind(s)),t.Headers=s.Headers,t.Request=s.Request,t.Response=s.Response;var a=n.exports;const o=["cards","collections","entries"],l=[...o,"tags"];function i(e){const{fields:t,references:s}=e,r={};s&&s.forEach((e=>{const{type:t,path:s,id:n}=e;"content-fragment"===t&&(r[s]=n)}));const n=t.reduce(((e,{name:t,multiple:s,values:n,mimeType:a})=>(o.includes(t)?e[t]=n.map((e=>"string"==typeof e&&r[e]||e)):e[t]="text/html"===a?{mimeType:a,value:n[0]}:s?n:n[0],e)),{});return n}function c(e,t){if(!e)return[];const s=[];for(const[r,n]of Object.entries(e))l.includes(r)&&Array.isArray(n)&&n.forEach((e=>{if(t[e]){const n={fieldName:r,identifier:e,referencesTree:[]},a=t[e];"content-fragment"===a.type&&(n.referencesTree=c(a.value.fields,t)),s.push(n)}}));return s}function u(e){if(!e.references)return e;const t=(e,s)=>{const r=i(s);s.references&&s.references.length>0&&s.references.forEach((s=>{Object.keys(e).find((e=>e===s.id))||t(e,s)})),e[s.id]={type:s.type,value:{name:s.name||"",title:s.title||"",description:s.description||"",path:s.path||"",id:s.id,model:{id:s.model?.id},fields:r}},s.tags&&Array.isArray(s.tags)&&s.tags.forEach((t=>{t&&t.id&&!e[t.id]&&(e[t.id]={type:"tag",value:{id:t.id,name:t.name||"",title:t.title||"",path:t.path||"",description:void 0!==t.description?t.description:null,i18n:t.i18n||[],titlePath:t.titlePath||""}})}))};return e.references&&(e.references=e.references.reduce(((e,s)=>(t(e,s),e)),{}),e.referencesTree=c(e.fields,e.references)),e}var d={transformBody:function(e){return e.fields=i(e),e=u(e)}};const f=a,{transformBody:p}=d;function h(e,t="info"){return`[${t}][${e.api_key}][${e.requestId}][${e.transformer}]`}function y(e,t){console.log(`${h(t)} ${e}`)}function m(e,t){console.error(`${h(t,"error")} ${e}`)}function g(e,t){t.debugLogs&&console.log(`${h(t,"debug")} ${e()}`)}async function b(e){let t="nok";try{const s=await e.json();t=s?.detail}catch(e){}return t}async function x(e,t){let s=await e.json();return t.preview&&Array.isArray(s.fields)&&(y("massaging old school schema for preview",t),s=p(s)),s}var w={fetch:async function(e,t){try{const s=Date.now(),r=await f(e,{headers:t.DEFAULT_HEADERS}),n=200==r.status,a=n?"ok":await b(r);return y(`fetch ${e} (${r?.status}) ${a} in ${Date.now()-s}ms`,t),g((()=>`response headers: ${JSON.stringify(Object.fromEntries(r.headers.entries()))}`),t),200===r.status?{status:200,body:await x(r,t)}:r}catch(s){m(`[fetch] ${e} fetch error: ${s.message}`,t)}return{...t,status:500,message:"fetch error"}},getErrorContext:async function(e){return{status:e.status,message:await b(e)}},log:y,logDebug:g,logError:m};const v="/content/dam/mas",T="https://odin.adobe.com/adobe/sites/fragments";function $(e){return`${e?.url?e.url:T}`}function R(e,t){return`${$(t)}/${e}`}var E={PATH_TOKENS:/\/content\/dam\/mas\/(?<surface>[\w-_]+)\/(?<parsedLocale>[\w-_]+)\/(?<fragmentPath>.+)/,FRAGMENT_URL_PREFIX:T,MAS_ROOT:v,odinPath:function(e,t,s,r){return`${$(r)}?path=${v}/${e}/${t}/${s}`},odinId:R,odinReferences:function(e,t=!1,s){return`${R(e,s)}${t?"?references=all-hydrated":""}`}};const{fetch:P,getErrorContext:A}=w,{odinReferences:O}=E;var S=async function(e){const{id:t,locale:s,translatedId:r,preview:n}=e;if(t&&s){const s=O(r||t,!0,n),a=await P(s,e);return 200==a.status?{...e,body:a.body}:A(a)}return{...e,status:400,message:"requested parameters are not present"}};const{PATH_TOKENS:_,odinPath:L,odinReferences:j}=E,{fetch:k,log:N}=w;var I=async function(e){const{body:t,locale:s,preview:r}=e;let n;const a=t?.path?.match(_);if(!a)return{status:400,message:"source path is either not here or invalid"};const{surface:o,parsedLocale:l,fragmentPath:i}=a.groups;if(s&&l!==s){const t=L(o,s,i,r),a=await k(t,e);if(200!=a.status)return{status:500,message:"translation search failed"};const{items:[{id:l}={}]}=a.body;if(!l)return{status:404,message:"no translation found"};{const t=j(l,!0,r),s=await k(t,e);if(200!=s.status)return{status:500,message:"translation search failed"};n=s.body,e.translatedId=l}}else N("no translation needed",e);return{...e,status:200,body:n||t,surface:o,parsedLocale:l,fragmentPath:i}};const{odinReferences:F,odinPath:M}=E,{fetch:D,log:H,logDebug:q,logError:W}=w,U=/{{(\s*([\w\-\_]+)\s*)}}/gi;async function z(e){const t=e.dictionary||{},s=e.dictionaryId??await async function(e){const{surface:t,locale:s,preview:r}=e,n=M(t,s,"dictionary/index",r),a=await D(n,e);if(200==a.status){const{items:t}=a.body;if(t?.length>0){const s=t[0].id;return e.dictionaryId=s,s}}return null}(e);if(!s)return t;const r=await D(F(s,!0,e.preview),e);if(200==r.status){const e=r.body.references;return Object.keys(e).forEach((s=>{const r=e[s]?.value?.fields;r?.key&&(t[r.key]=function(e){return(e.value||e.richTextValue?.value||"").replace(/[\u0000-\u001F\u007F-\u009F]/g,"").replace(/"/g,'\\"')}(r))})),t}return t}function C(e,t,s){const r=e.matchAll(U);let n="",a=0;for(const o of r){const r=o[1];n+=e.slice(a,o.index);let l=null==t[r]||s.includes(r)?r:t[r];l?.match(U)&&(s.push(r),l=C(l,t,s),s.pop()),n+=l,a=o.index+o[0].length}return n+=e.slice(a),n}var J=async function(e){let t=e.body,s=JSON.stringify(t);if(s.match(U)){const r=await z(e);if(r&&Object.keys(r).length>0){s=C(s,r,[]);try{t=JSON.parse(s)}catch(t){W(`[replace] ${t.message}`,e),q((()=>`[replace] invalid json: ${s}`),e)}}}else H("no placeholders found in fragment content",e);return{...e,status:200,body:t}};function B(e,t){e.settings={},!1!==e?.fields?.showSecureLabel&&(e.settings.secureLabel="{{secure-label}}"),null!=e?.fields?.showPlanType&&(e.settings.displayPlanType=e?.fields?.showPlanType),"en_US"===t&&(e.settings.displayPlanType??=!0)}var G=async function(e){const{locale:t}=e;return e.body?.fields?.variant?.startsWith("plans")&&B(e.body,t),"L2NvbmYvbWFzL3NldHRpbmdzL2RhbS9jZm0vbW9kZWxzL2NvbGxlY3Rpb24"===e.body?.model?.id&&function(e){e.body.placeholders={searchText:"{{coll-search-text}}",filtersText:"{{coll-filters-text}}",sortText:"{{coll-sort-text}}",popularityText:"{{coll-popularity-text}}",alphabeticallyText:"{{coll-alphabetically-text}}",noResultsText:"{{coll-no-results-text}}",plansSidenavTitle:"{{coll-plans-sidenav-title}}",resultText:"{{coll-result-text}}",resultsText:"{{coll-results-text}}",resultMobileText:"{{coll-result-mobile-text}}",resultsMobileText:"{{coll-results-mobile-text}}",searchResultText:"{{coll-search-result-text}}",searchResultsText:"{{coll-search-results-text}}",searchResultMobileText:"{{coll-search-result-mobile-text}}",searchResultsMobileText:"{{coll-search-results-mobile-text}}",noSearchResultsText:"{{coll-no-search-results-text}}",showMoreText:"{{coll-show-more-text}}"},e.dictionary={...e?.dictionary,"coll-filter":'<span data-placeholder=\\"filter\\"></span>',"coll-result-count":'<span data-placeholder=\\"resultCount\\"></span>',"coll-search-term":'<span data-placeholder=\\"searchTerm\\"></span>'}}(e),e.body?.references&&Object.entries(e.body.references).forEach((([e,s])=>{s&&"content-fragment"===s.type&&s.value?.fields?.variant?.startsWith("plans")&&B(s.value,t)})),e};async function K(e,t){const{locale:s="en_US",preview:r={url:"https://odinpreview.corp.adobe.com/adobe/sites/cf/fragments"}}=t;let n={id:e,status:200,preview:r,requestId:"preview",api_key:"n/a",locale:s};for(const e of[S,I,G,J]){if(200!=n.status){w.logError(n.message,n);break}n.transformer=e.name,n=await e(n)}return 200!=n.status&&w.logError(n.message,n),n.body}export{K as previewFragment};
//# sourceMappingURL=fragment-client.js.map
