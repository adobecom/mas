<!doctype html>
<html>
    <head>
        <title>Prosemirror RTE Editor custom element</title>
        <meta name="nofollow-links" content="on" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            main {
                margin: 32px;
                display: grid;
                gap: 32px;
                grid-template-columns: 1fr 1fr;
                height: 90vh;
            }

            sp-theme {
                display: contents;
            }

            rte-editor {
                max-height: 500px;
            }

            #ost {
                width: 80vw;
                height: 80vh;
            }
        </style>
        <!-- OST -->
        <script src="../../ost/index.js"></script>
        <link rel="stylesheet" href="../../ost/index.css" />
    </head>
    <body>
        <script type="module">
            import { runTests } from '@web/test-runner-mocha';
            import { expect } from '@esm-bundle/chai';

            import '../../src/swc.js';
            import '../../src/rte/rte-editor.js';
            import '../../src/rte/rte-link-editor.js';
            import '@adobecom/milo/libs/deps/mas/mas.js';
            import { mockFetch } from '@adobecom/milo/libs/features/mas/mocks/fetch.js';
            import { withWcs } from '@adobecom/milo/libs/features/mas/mocks/wcs.js';
            import { openOfferSelectorTool } from '../../src/ost.js';

            import {
                createFromTemplate,
                delay,
                simulateClick,
                selectWordsInTextNode,
            } from '../utils.js';

            runTests(async () => {
                await mockFetch(withWcs);
                describe('RTE Editor', () => {
                    it('should render with default attributes', async function () {
                        const rte = await createFromTemplate(
                            'rte',
                            this.test.title,
                        );
                        expect(rte.shadowRoot).exist;
                    });
                });

                // Theses are not very stable in headless chrome. Enable them for localing.
                describe('RTE Editor: link features', () => {
                    let rte;
                    const clickSave = () => {
                        const saveButton =
                            rte.linkEditorElement.shadowRoot.getElementById(
                                'saveButton',
                            );
                        saveButton.click();
                    };

                    const openLinkEditor = async function () {
                        rte.linkEditorButtonElement.click();
                        rte.requestUpdate();
                        await rte.updateComplete;
                        await rte.linkEditorElement;
                    };

                    const firstLink = () =>
                        rte.shadowRoot.querySelector('.ProseMirror a');

                    const firstParagraph = () =>
                        rte.shadowRoot.querySelector('.ProseMirror p');

                    it('should allow to remove a link', async function () {
                        rte = await createFromTemplate(
                            'rte-link',
                            this.test.title,
                        );
                        await selectWordsInTextNode(
                            firstLink().firstChild,
                            'Adobe',
                        );
                        await delay(100);
                        rte.unlinkEditorButtonElement.click();
                        await delay(100);
                        expect(rte.value).to.equal('<p>Adobe</p>');
                    });

                    it('should open the link editor on link click and support update', async function () {
                        rte = await createFromTemplate(
                            'rte-link',
                            this.test.title,
                        );
                        await simulateClick(firstLink(), 20, 10);
                        await openLinkEditor();
                        const { url, text, title, target, checkoutParameters } =
                            rte.linkEditorElement;
                        expect(url).to.equal('https://www.adobe.com');
                        expect(text).to.equal('Adobe');
                        expect(title).to.equal('adobe.com homepage');
                        expect(target).to.equal('_self');
                        rte.linkEditorElement.url = 'https://www.adobe.com/max';
                        rte.linkEditorElement.text = 'ebodA';
                        rte.linkEditorElement.requestUpdate();
                        clickSave();
                        await delay(100);
                        const a = firstLink();
                        expect(a.href).to.equal('https://www.adobe.com/max');
                        expect(a.innerText).to.equal('ebodA');
                    });

                    it('should open the link editor on selection and support update', async function () {
                        rte = await createFromTemplate('rte', this.test.title);
                        await selectWordsInTextNode(
                            firstParagraph().firstChild,
                            'only',
                        );
                        await delay(100);
                        await openLinkEditor();
                        await rte.linkEditorElement.updateComplete;
                        expect(rte.linkEditorElement.text).to.equal('only');
                        rte.linkEditorElement.url = 'https://www.adobe.com';
                        rte.linkEditorElement.text = 'and links';
                        rte.linkEditorElement.title = 'Adobe homepage';
                        rte.linkEditorElement.requestUpdate();
                        clickSave();
                        await delay(100);
                        const a = firstLink();
                        expect(a.href).to.equal('https://www.adobe.com/');
                        expect(a.innerText).to.equal('and links');
                        expect(a.title).to.equal('Adobe homepage');
                    });

                    it('should open the link editor and support inserting link', async function () {
                        rte = await createFromTemplate('rte', this.test.title);
                        await openLinkEditor();
                        rte.linkEditorElement.url = 'https://www.adobe.com';
                        rte.linkEditorElement.text = 'Adobe';
                        rte.linkEditorElement.title = 'Adobe homepage';
                        rte.linkEditorElement.requestUpdate();
                        await rte.linkEditorElement.updateComplete;
                        clickSave();
                        await delay(100);
                        const a = firstLink();
                        expect(a.href).to.equal('https://www.adobe.com/');
                        expect(a.innerText).to.equal('Adobe');
                        expect(a.title).to.equal('Adobe homepage');
                    });
                });

                // Theses are not very stable in headless chrome. Enable them for localing.
                describe('RTE Editor: OST features', () => {
                    let rte;

                    const openOST = async function () {
                        rte.linkEditorButtonElement.click();
                        rte.requestUpdate();
                        await rte.updateComplete;
                        await rte.linkEditorElement;
                    };

                    const firstPrice = () =>
                        rte.shadowRoot.querySelector(
                            '.ProseMirror span[is="inline-price"]',
                        );

                    const firstCheckoutLink = () =>
                        rte.shadowRoot.querySelector(
                            '.ProseMirror a[is="checkout-link"]',
                        );

                    it('should open OST', async function () {
                        if (!localStorage.getItem('masAccessToken')) {
                            localStorage.setItem('masAccessToken', 'test');
                        }
                        const rte = await createFromTemplate(
                            'rte-all',
                            this.test.title,
                        );
                        await delay(100);
                        expect(rte.value).to.equal(
                            '<p><span is="inline-price" data-wcs-osi="abm"></span><a is="checkout-link" class="accent" data-wcs-osi="abm">Buy now</a><a is="checkout-link" class="primary-outline" data-wcs-osi="abm">Buy now</a><a is="checkout-link" class="secondary" data-wcs-osi="abm">Buy now</a><a is="checkout-link" class="secondary-outline" data-wcs-osi="abm">Buy now</a><a is="checkout-link" class="primary-link" data-wcs-osi="abm">Buy now</a><a is="checkout-link" class="secondary-link" data-wcs-osi="abm">Buy now</a></p>',
                        );

                        rte.offerSelectorToolButtonElement.click();
                        await delay(100);
                        const cancelButton = document.querySelector(
                            '[data-testid="productsTab/cancelButton"]',
                        );
                        expect(cancelButton).to.exist;
                        cancelButton.click();
                    });

                    it('should recognize markup created with TinyMCE', async function () {
                        const rte = await createFromTemplate(
                            'rte-tinymce',
                            this.test.title,
                        );
                        await delay(100);
                        expect(rte.value).to.equal(
                            '<p>&nbsp;<a is="checkout-link" class="accent" data-checkout-workflow="UCv3" data-checkout-workflow-step="email" data-promotion-code="" data-wcs-osi="Mutn1LYoGojkrcMdCLO7LQlx1FyTHw27ETsfLv0h8DQ">Get Offer</a>&nbsp;</p><p><a is="checkout-link" class="accent" data-checkout-workflow="UCv3" data-checkout-workflow-step="email" data-promotion-code="" data-wcs-osi="Mutn1LYoGojkrcMdCLO7LQlx1FyTHw27ETsfLv0h8DQ">Buy now</a></p><p><a is="checkout-link" class="accent" data-checkout-workflow="UCv3" data-checkout-workflow-step="email" data-promotion-code="" data-wcs-osi="Mutn1LYoGojkrcMdCLO7LQlx1FyTHw27ETsfLv0h8DQ">Buy now</a></p><p><a is="checkout-link" class="accent" data-checkout-workflow="UCv3" data-checkout-workflow-step="email" data-promotion-code="" data-wcs-osi="Hnk2P6L5wYhnpZLFYTW5upuk2Y3AJXlso8VGWQ0l2TI">Buy now</a></p>',
                        );
                    });
                });
            });
        </script>
        <mas-commerce-service></mas-commerce-service>
        <button
            onclick="toggleTheme()"
            style="position: absolute; right: 0; bottom: 0"
        >
            Toggle theme
        </button>
        <main>
            <sp-theme color="light" scale="medium"> </sp-theme>
        </main>
        <template id="rte">
            <rte-editor>
                <p>Text only</p>
            </rte-editor>
        </template>
        <template id="rte-link">
            <rte-editor>
                <a href="https://www.adobe.com" title="adobe.com homepage"
                    >Adobe</a
                >
            </rte-editor>
        </template>
        <template id="rte-all">
            <rte-editor>
                <span is="inline-price" data-wcs-osi="abm"></span
                ><a class="accent" is="checkout-link" data-wcs-osi="abm"
                    >Buy now</a
                ><a
                    class="primary-outline"
                    is="checkout-link"
                    data-wcs-osi="abm"
                    >Buy now</a
                ><a class="secondary" is="checkout-link" data-wcs-osi="abm"
                    >Buy now</a
                ><a
                    class="secondary-outline"
                    is="checkout-link"
                    data-wcs-osi="abm"
                    >Buy now</a
                ><a class="primary-link" is="checkout-link" data-wcs-osi="abm"
                    >Buy now</a
                ><a class="secondary-link" is="checkout-link" data-wcs-osi="abm"
                    >Buy now</a
                >
            </rte-editor>
        </template>
        <template id="rte-tinymce">
            <rte-editor>
                <div
                    data-mce-bogus="all"
                    class="mce-offscreen-selection"
                    id="sel-mce_0"
                    style="top: 18px"
                >
                    &nbsp;<a
                        is="checkout-link"
                        data-checkout-workflow="UCv3"
                        data-checkout-workflow-step="email"
                        data-promotion-code=""
                        data-quantity="1"
                        data-wcs-osi="Mutn1LYoGojkrcMdCLO7LQlx1FyTHw27ETsfLv0h8DQ"
                        href=""
                        data-ims-country="DE"
                        >Get Offer</a
                    >&nbsp;
                </div>
                <p>
                    <strong
                        ><a
                            is="checkout-link"
                            data-checkout-workflow="UCv3"
                            data-checkout-workflow-step="email"
                            data-promotion-code=""
                            data-quantity="1"
                            data-wcs-osi="Mutn1LYoGojkrcMdCLO7LQlx1FyTHw27ETsfLv0h8DQ"
                            href=""
                            >Buy now</a
                        ></strong
                    >
                </p>
                <p>
                    <strong
                        ><a
                            data-checkout-workflow="UCv3"
                            data-checkout-workflow-step="email"
                            data-promotion-code=""
                            data-quantity="1"
                            data-wcs-osi="Mutn1LYoGojkrcMdCLO7LQlx1FyTHw27ETsfLv0h8DQ"
                            is=""
                            >Buy now</a
                        ></strong
                    >
                </p>
                <p>
                    <a
                        is="checkout-link"
                        href=""
                        data-checkout-workflow="UCv3"
                        data-checkout-workflow-step="email"
                        data-promotion-code=""
                        data-quantity="1"
                        data-wcs-osi="Hnk2P6L5wYhnpZLFYTW5upuk2Y3AJXlso8VGWQ0l2TI"
                        >Buy now</a
                    >
                </p>
            </rte-editor>
        </template>
    </body>
</html>
