<!doctype html>
<html>
    <head>
        <script>
            window.__swc = { warn: () => {} };
        </script>
        <script type="module">
            window.process = { env: {} };
        </script>
        <title>editor-panel custom element test page</title>
        <meta name="nofollow-links" content="on" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="../style.css" />
        <style>
            body {
                margin: 32px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            sp-theme {
                display: contents;
            }

            editor-panel {
                width: 600px;
                top: 32px;
                bottom: 32px;
                height: initial;
            }
        </style>
        <mas-repository base-url="http://localhost:2023/test/mocks"></mas-repository>
    </head>
    <body>
        <script type="module">
            import { runTests } from '@web/test-runner-mocha';
            import { expect } from '@esm-bundle/chai';
            import sinon from 'sinon';
            import { html } from 'lit';
            import { fixture, oneEvent } from '@open-wc/testing-helpers';
            import '../src/swc.js';
            import '../src/rte/rte-field.js';
            import '../src/aem/aem-tag-picker-field.js';
            import '../src/editor-panel.js';
            import '../src/editors/merch-card-editor.js';
            import '../src/editors/version-panel.js';
            import '../src/mas-repository.js';
            import { Fragment } from '../src/aem/fragment.js';
            import { FragmentStore } from '../src/reactivity/fragment-store.js';
            import Store from '../src/store.js';
            import { generateCodeToUse } from '../src/utils.js';
            import { createFromTemplate, delay, triggerInput, triggerRteInput } from './utils.js';

            runTests(async () => {
                const spTheme = document.querySelector('sp-theme');

                const originalFetch = window.fetch;
                const fragmentData = await originalFetch('/test/mocks/adobe/sites/cf/fragments/cc-all-apps').then((res) =>
                    res.json(),
                );

                window.fetch = async function (args) {
                    const { pathname } = new URL(args);
                    if (/querybuilder.json?path=\/content\/cq:tags\/mas/.test(pathname)) {
                        return originalFetch('/test/mocks/tags.json');
                    }
                    if (/querybuilder.json?path=\/content\/dam\/mas/.test(pathname)) {
                        return originalFetch('/test/mocks/folders.json');
                    }
                    if (/querybuilder.json?path=\/content\/dam\/mas/.test(pathname)) {
                        return originalFetch('/test/mocks/folders.json');
                    }
                    return originalFetch(...arguments);
                };

                describe('editor-panel custom element', () => {
                    let fragment;
                    let fragmentStore;
                    let editorPanel;
                    beforeEach(async () => {
                        fragment = new Fragment(fragmentData);
                        fragmentStore = new FragmentStore(fragment);
                        editorPanel = await fixture(html`<editor-panel></editor-panel>`, { parentNode: spTheme });
                        editorPanel.repository.aem.sites.cf.fragments.getVersions = async () => ({ items: [] });
                        await editorPanel.editFragment(fragmentStore);
                        await editorPanel.updateComplete;
                    });

                    it('implements "discard changes"', async () => {
                        const discardButton = document.querySelector('sp-action-button[value="discard"]');
                        expect(discardButton.disabled).to.be.true;
                        // Poll until editorView is ready
                        let field = document.getElementById('card-title');
                        let attempts = 0;
                        while ((!field || !field.editorView) && attempts < 20) {
                            await delay(100);
                            field = document.getElementById('card-title');
                            attempts++;
                        }
                        expect(field, 'field should exist').to.exist;
                        expect(field.editorView, 'editorView should be initialized').to.exist;
                        triggerRteInput(field, 'test title');
                        expect(fragment.getField('cardTitle').values).to.deep.equal(['test title']);
                        await editorPanel.updateComplete;
                        await delay(100);
                        expect(Store.editor.hasChanges).to.be.true;
                        expect(discardButton.disabled).to.be.false;
                        discardButton.click();
                        await delay(100);
                        const btnDiscard = document.querySelector('#btnDiscard');
                        btnDiscard.click();
                        await delay(100);
                        expect(fragment.getField('cardTitle').values).to.deep.equal([]);
                        expect(field.innerHTML).to.equal('');
                        // Re-query the field after discard to get the newly created element
                        field = document.getElementById('card-title');
                        await delay(100); // Allow time for re-render to complete
                        expect(field.value).to.equal('');
                    });

                    it('implements "use"', async () => {
                        Store.search.set((prev) => ({
                            ...prev,
                            path: 'acom',
                        }));
                        await editorPanel.updateComplete;
                        await editorPanel.refreshed;
                        // Poll until editorView is ready
                        let field = document.getElementById('card-title');
                        let attempts = 0;
                        while ((!field || !field.editorView) && attempts < 20) {
                            await delay(100);
                            field = document.getElementById('card-title');
                            attempts++;
                        }
                        expect(field, 'field should exist').to.exist;
                        expect(field.editorView, 'editorView should be initialized').to.exist;
                        triggerRteInput(field, 'test title');
                        await editorPanel.updateComplete;
                        const { authorPath, href, richText } = generateCodeToUse(
                            editorPanel.fragment,
                            Store.search.get().path,
                            Store.page.get(),
                        );
                        const normalizedExpected =
                            '<ahref="https://mas.adobe.com/studio.html#content-type=merch-card&page=welcome&path=acom&query=cc-all-apps"target="_blank">merch-card:ACOM/Slice/CreativeCloudAllApps</a>';
                        const normalizedActual = richText.replace(/\s+/g, '');
                        expect(normalizedActual).to.equal(normalizedExpected);
                        expect(authorPath).to.equal('merch-card: ACOM / Slice / Creative Cloud All Apps');
                        expect(href).to.equal(
                            'https://mas.adobe.com/studio.html#content-type=merch-card&page=welcome&path=acom&query=cc-all-apps',
                        );
                    });

                    it('displays version history button in toolbar', async () => {
                        await editorPanel.editFragment(fragmentStore);
                        await editorPanel.updateComplete;

                        // Check that the version history button exists
                        const versionButton = document.querySelector('sp-action-button[value="version-history"]');
                        expect(versionButton).to.exist;
                        expect(versionButton.label).to.equal('Version History');

                        // Check that it has the history icon
                        const icon = versionButton.querySelector('sp-icon-history');
                        expect(icon).to.exist;
                    });

                    it('navigates to version page when version history button is clicked', async () => {
                        await editorPanel.editFragment(fragmentStore);
                        await editorPanel.updateComplete;

                        const versionButton = document.querySelector('sp-action-button[value="version-history"]');
                        expect(versionButton).to.exist;

                        // Store original Store.version.fragmentId value
                        const Store = await import('../src/store.js').then((m) => m.default);
                        const originalFragmentId = Store.version.fragmentId.get();

                        // Click the button
                        versionButton.click();
                        await delay(100);

                        // Verify the fragment ID was stored
                        expect(Store.version.fragmentId.get()).to.equal(fragment.id);

                        // Restore original value
                        Store.version.fragmentId.set(originalFragmentId);
                    });
                });
            });
        </script>
        <sp-theme system="spectrum-two" color="light" scale="medium"></sp-theme>
    </body>
</html>
