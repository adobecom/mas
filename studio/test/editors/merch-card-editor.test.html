<!doctype html>
<html>
    <head>
        <script type="module">
            window.process = { env: {} };
            window.__swc = { warn: () => {} };

            // Set up fetch mock before any components are loaded
            const originalFetch = window.fetch;
            // Load offers for WCS mock
            const offersPromise = originalFetch('/test/mocks/offers.json').then((r) => r.json());

            window.fetch = async function (args) {
                try {
                    const url = new URL(args);
                    const { pathname, search } = url;
                    const fullPath = pathname + search;

                    if (/querybuilder\.json\?path=\/content\/cq:tags\/mas/.test(fullPath)) {
                        return originalFetch('/test/mocks/tags.json');
                    }
                    if (/querybuilder\.json\?path=\/content\/dam\/mas/.test(fullPath)) {
                        return originalFetch('/test/mocks/folders.json');
                    }
                    // Mock WCS offer fetch
                    if (pathname.includes('web_commerce_artifact')) {
                        const offers = await offersPromise;
                        const osi = url.searchParams.get('offer_selector_ids');
                        const language = url.searchParams.get('language')?.toLowerCase() || 'mult';
                        const offerKey = `${osi}-${language}`;
                        const offerData = offers[offerKey] || offers[osi];
                        if (offerData) {
                            return new Response(
                                JSON.stringify({
                                    resolvedOffers: offerData.map((offer) => ({
                                        ...offer,
                                        offerSelectorIds: [osi],
                                    })),
                                }),
                                { status: 200, headers: { 'Content-Type': 'application/json' } },
                            );
                        }
                        return new Response(JSON.stringify({ error: 'Not found' }), { status: 404 });
                    }
                    return originalFetch(...arguments);
                } catch (e) {
                    return originalFetch(...arguments);
                }
            };
        </script>
        <title>merch-card-editor mnemonic tests</title>
        <meta name="nofollow-links" content="on" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="../../style.css" />
        <style>
            body {
                margin: 32px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            sp-theme {
                display: block;
                width: 100%;
            }
            mas-fragment-editor {
                display: block;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <script type="module">
            import { runTests } from '@web/test-runner-mocha';
            import { expect } from '@esm-bundle/chai';
            import { html } from 'lit';
            // Import actual components
            import '../../src/swc.js';
            import '../../src/rte/rte-field.js';
            import '../../src/aem/aem-tag-picker-field.js';
            import '../../src/mas-fragment-editor.js';
            import '../../src/mas-repository.js';
            // Import aem-fragment, mas-commerce-service, and merch-card from web-components
            import '../../../web-components/src/mas-commerce-service.js';
            import '../../../web-components/src/aem-fragment.js';
            import '../../../web-components/src/merch-card.js';
            // Import data classes
            import { Fragment } from '../../src/aem/fragment.js';
            import generateFragmentStore from '../../src/reactivity/source-fragment-store.js';
            import Store from '../../src/store.js';
            import { PAGE_NAMES } from '../../src/constants.js';
            import { delay } from '../utils.js';

            // Load the existing mock data for a merch card
            const baseMockData = await fetch('/test/mocks/adobe/sites/cf/fragments/cc-all-apps').then((res) => res.json());

            // Parent fragment (en_US default) with mnemonic - based on actual mock
            const parentFragmentData = {
                ...baseMockData,
                path: '/content/dam/mas/en_US/ccd-slice-cc-allapps',
                id: 'parent-fragment-id',
                fields: baseMockData.fields.map((field) => {
                    if (field.name === 'variant') {
                        return { ...field, values: ['plans'] };
                    }
                    if (field.name === 'mnemonicIcon') {
                        return { ...field, values: ['/test/mocks/img/creative-cloud.svg'] };
                    }
                    if (field.name === 'mnemonicAlt') {
                        return { ...field, values: ['Creative Cloud'] };
                    }
                    if (field.name === 'mnemonicLink') {
                        return { ...field, values: ['https://adobe.com'] };
                    }
                    return field;
                }),
            };

            // Variation fragment (en_AU) that inherits from parent - empty mnemonic fields = inherit
            const variationFragmentData = {
                ...baseMockData,
                path: '/content/dam/mas/en_AU/ccd-slice-cc-allapps',
                title: 'CCD Suggested CC All Apps (AU)',
                id: 'variation-fragment-id',
                fields: baseMockData.fields.map((field) => {
                    if (field.name === 'variant') {
                        return { ...field, values: ['plans'] };
                    }
                    if (field.name === 'mnemonicIcon') {
                        return { ...field, values: [] }; // Empty = inherit
                    }
                    if (field.name === 'mnemonicAlt') {
                        return { ...field, values: [] };
                    }
                    if (field.name === 'mnemonicLink') {
                        return { ...field, values: [] };
                    }
                    return field;
                }),
            };

            runTests(async () => {
                const spTheme = document.querySelector('sp-theme');

                describe('merch-card-editor', () => {
                    it('removes inherited mnemonic and restores it via override indicator', async () => {
                        console.log('[TEST] Starting test...');

                        // Create fragment and fragment store
                        const variationFragment = new Fragment(structuredClone(variationFragmentData));
                        const parentFragment = new Fragment(structuredClone(parentFragmentData));
                        const fragmentStore = generateFragmentStore(variationFragment, { skipAutoResolve: true });
                        console.log('[TEST] Created fragments and store');

                        // Set up Store - this is how mas-fragment-editor gets the fragment
                        Store.page.set(PAGE_NAMES.FRAGMENT_EDITOR);
                        Store.fragmentEditor.fragmentId.set('variation-fragment-id');
                        Store.fragments.inEdit.set(fragmentStore);
                        Store.fragments.list.data.set([fragmentStore]);
                        console.log('[TEST] Store configured');

                        // Create mas-fragment-editor
                        const fragmentEditor = document.createElement('mas-fragment-editor');
                        console.log('[TEST] Created mas-fragment-editor element');

                        // Mock repository methods before appending
                        const repository = document.querySelector('mas-repository');
                        repository.refreshFragment = async () => {};
                        repository.loadPreviewPlaceholders = async () => {};
                        console.log('[TEST] Mocked repository methods');

                        // Mock editorContextStore before appending
                        fragmentEditor.editorContextStore = {
                            loadFragmentContext: async () => {},
                            isVariation: () => true,
                            getLocaleDefaultFragmentAsync: async () => structuredClone(parentFragmentData),
                            getDefaultLocaleId: () => 'parent-fragment-id',
                            getLocaleDefaultFragment: () => structuredClone(parentFragmentData),
                        };
                        console.log('[TEST] Mocked editorContextStore');

                        // Set locale default fragment directly
                        fragmentEditor.localeDefaultFragment = parentFragment;
                        fragmentEditor.contextLoaded = true;
                        fragmentEditor.initializationComplete = true;
                        console.log('[TEST] Set locale default fragment and flags');

                        // Set up placeholders and surface for preview resolution
                        Store.placeholders.preview.set({});
                        Store.search.set((prev) => ({ ...prev, surface: 'web' }));
                        console.log('[TEST] Set placeholders and surface');

                        // Mark preview as resolved so it doesn't show skeleton
                        fragmentStore.previewStore.resolved = true;
                        console.log('[TEST] Marked preview as resolved');

                        // Populate aem-fragment cache with the fragment data for preview rendering
                        const AemFragment = customElements.get('aem-fragment');
                        if (AemFragment?.cache) {
                            AemFragment.cache.add(fragmentStore.previewStore.value);
                        }
                        console.log('[TEST] Populated aem-fragment cache');

                        // Append to DOM
                        spTheme.appendChild(fragmentEditor);
                        console.log('[TEST] Appended fragmentEditor to DOM');

                        // Merge parent fields into preview store (simulates what initFragment does)
                        fragmentEditor.mergeEssentialParentFields();
                        console.log('[TEST] Merged parent fields');

                        await fragmentEditor.updateComplete;
                        await delay(500);
                        console.log('[TEST] Waited for fragmentEditor.updateComplete');

                        // Get the merch-card-editor inside mas-fragment-editor
                        const editor = fragmentEditor.querySelector('merch-card-editor');
                        console.log('[TEST] Found merch-card-editor:', !!editor);
                        expect(editor).to.exist;

                        // Wait for editor to be fully ready (fieldsReady = true)
                        let waitAttempts = 0;
                        console.log('[TEST] Initial editor state:', {
                            fieldsReady: editor.fieldsReady,
                            fragmentStore: !!editor.fragmentStore,
                            fragment: !!editor.fragment,
                            'fragment.variant': editor.fragment?.variant,
                            currentVariantMapping: !!editor.currentVariantMapping,
                        });
                        while (!editor.fieldsReady) {
                            await editor.updateComplete;
                            await delay(50);
                            waitAttempts++;
                            if (waitAttempts % 20 === 0) {
                                console.log(
                                    '[TEST] Waiting for fieldsReady... attempts:',
                                    waitAttempts,
                                    'state:',
                                    {
                                        fieldsReady: editor.fieldsReady,
                                        fragment: !!editor.fragment,
                                        'fragment.variant': editor.fragment?.variant,
                                        currentVariantMapping: !!editor.currentVariantMapping,
                                    },
                                );
                            }
                            if (waitAttempts > 80) {
                                console.log('[TEST] TIMEOUT waiting for fieldsReady. Current state:', {
                                    fieldsReady: editor.fieldsReady,
                                    fragmentStore: !!editor.fragmentStore,
                                    fragment: !!editor.fragment,
                                    'fragment.variant': editor.fragment?.variant,
                                    currentVariantMapping: !!editor.currentVariantMapping,
                                });
                                break;
                            }
                        }
                        console.log(
                            '[TEST] fieldsReady loop complete. fieldsReady:',
                            editor.fieldsReady,
                            'attempts:',
                            waitAttempts,
                        );

                        // Verify editor renders without skeleton
                        expect(editor.fieldsReady, 'Editor fieldsReady should be true').to.be.true;
                        const editorSkeleton = editor.querySelector('.editor-skeleton-wrapper');
                        const editorSkeletonDisplay = editorSkeleton
                            ? getComputedStyle(editorSkeleton).getPropertyValue('--skeleton-display')
                            : 'none';
                        expect(editorSkeletonDisplay.trim(), 'Editor should not show skeleton').to.equal('none');

                        // Verify preview renders without skeleton
                        const previewColumn = fragmentEditor.querySelector('#preview-column');
                        expect(previewColumn).to.exist;
                        const previewSkeleton = previewColumn.querySelector('.preview-skeleton');
                        expect(previewSkeleton, 'Preview should not show skeleton').to.be.null;
                        const merchCard = previewColumn.querySelector('merch-card');
                        expect(merchCard, 'Preview should render merch-card').to.exist;

                        // Step 1: Verify editor renders with inherited mnemonic
                        expect(editor.effectiveIsVariation).to.be.true;
                        expect(editor.getFieldState('mnemonicIcon')).to.equal('inherited');
                        expect(editor.mnemonics).to.have.length(1);
                        expect(editor.mnemonics[0].icon).to.equal('/test/mocks/img/creative-cloud.svg');

                        // Step 2: Find and click delete on the mnemonic field
                        const multifield = editor.querySelector('mas-multifield#mnemonics');
                        expect(multifield).to.exist;

                        const mnemonicField = multifield.shadowRoot.querySelector('mas-mnemonic-field');
                        expect(mnemonicField).to.exist;

                        // Simulate delete by dispatching the delete-field event
                        mnemonicField.dispatchEvent(new CustomEvent('delete-field', { bubbles: true, composed: true }));

                        await editor.updateComplete;
                        await delay(200);

                        // Step 3: Verify mnemonic is removed and state is overridden
                        expect(editor.getFieldState('mnemonicIcon')).to.equal('overridden');
                        expect(editor.mnemonics).to.have.length(0);
                        expect(editor.getEffectiveFieldValues('mnemonicIcon')).to.deep.equal([]);

                        // Step 4: Find and click "Overridden. Click to restore" link
                        const overrideIndicator = editor.querySelector('.field-status-indicator a');
                        expect(overrideIndicator).to.exist;
                        expect(overrideIndicator.textContent).to.include('Overridden');

                        overrideIndicator.click();

                        await editor.updateComplete;
                        await delay(200);

                        // Step 5: Verify mnemonic is restored from parent (inherits)
                        expect(editor.getFieldState('mnemonicIcon')).to.equal('inherited');
                        expect(editor.mnemonics).to.have.length(1);
                        expect(editor.mnemonics[0].icon).to.equal('/test/mocks/img/creative-cloud.svg');

                        // DOM is preserved - do not remove editor
                    });
                });
            });
        </script>
        <mas-commerce-service env="stage"></mas-commerce-service>
        <mas-repository base-url="http://localhost:2023/test/mocks"></mas-repository>
        <sp-theme system="spectrum-two" color="light" scale="medium"></sp-theme>
    </body>
</html>
