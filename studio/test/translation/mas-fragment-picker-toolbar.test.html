<!doctype html>
<html>
    <head>
        <script>
            window.__swc = { warn: () => {} };
        </script>
        <script type="module">
            window.process = { env: {} };
            window.__swc = { warn: () => {} };
        </script>
        <title>mas-fragment-picker-toolbar unit tests</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="../../src/swc.js" type="module"></script>
        <style>
            main {
                display: flex;
                flex-direction: column;
                gap: 32px;
            }

            sp-theme {
                display: contents;
            }

            mas-fragment-picker-toolbar {
                position: relative;
            }
        </style>
    </head>

    <body>
        <script type="module">
            import { runTests } from '@web/test-runner-mocha';
            import { expect } from '@esm-bundle/chai';
            import { delay, initElementFromTemplate, oneEvent } from '../utils.js';
            import '../../src/translation/mas-fragment-picker-toolbar.js';

            const templateOptions = [
                { id: 'plans', title: 'Plans' },
                { id: 'catalog', title: 'Catalog' },
                { id: 'ah', title: 'AH' },
            ];

            const marketSegmentOptions = [
                { id: 'mas:market_segment/com', title: 'Commercial' },
                { id: 'mas:market_segment/edu', title: 'Education' },
            ];

            const customerSegmentOptions = [
                { id: 'mas:customer_segment/individual', title: 'Individual' },
                { id: 'mas:customer_segment/team', title: 'Team' },
            ];

            const productOptions = [
                { id: 'mas:product_code/phsp', title: 'Photoshop' },
                { id: 'mas:product_code/ilst', title: 'Illustrator' },
                { id: 'mas:product_code/ppro', title: 'Premiere Pro' },
            ];

            function createToolbar(testTitle) {
                const toolbar = initElementFromTemplate('toolbar1', testTitle);
                toolbar.templateOptions = templateOptions;
                toolbar.marketSegmentOptions = marketSegmentOptions;
                toolbar.customerSegmentOptions = customerSegmentOptions;
                toolbar.productOptions = productOptions;
                return toolbar;
            }

            async function simulateTagDelete(toolbar, filterType, filterId) {
                const tags = toolbar.shadowRoot.querySelectorAll('sp-tag');
                const tag = Array.from(tags).find((t) => t.value?.type === filterType && t.value?.id === filterId);
                if (tag) {
                    tag.dispatchEvent(new CustomEvent('delete', { bubbles: true, composed: true }));
                    await delay(50);
                }
            }

            runTests(async () => {
                describe('mas-fragment-picker-toolbar custom element', async () => {
                    it('Should initialize with empty filter values', async function () {
                        const toolbar = createToolbar(this.test.title);
                        await toolbar.updateComplete;

                        expect(toolbar.templateFilter).to.deep.equal([]);
                        expect(toolbar.marketSegmentFilter).to.deep.equal([]);
                        expect(toolbar.customerSegmentFilter).to.deep.equal([]);
                        expect(toolbar.productFilter).to.deep.equal([]);
                    });

                    it('Should not show applied filters section when no filters are active', async function () {
                        const toolbar = createToolbar(this.test.title);
                        await toolbar.updateComplete;

                        const appliedFilters = toolbar.shadowRoot.querySelector('.applied-filters');
                        expect(appliedFilters).to.be.null;
                    });

                    it('Should show applied filter tags when filters are set', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.templateFilter = ['plans'];
                        toolbar.productFilter = ['mas:product_code/phsp'];
                        await toolbar.updateComplete;

                        const appliedFilters = toolbar.shadowRoot.querySelector('.applied-filters');
                        expect(appliedFilters).to.not.be.null;

                        const tags = toolbar.shadowRoot.querySelectorAll('sp-tag');
                        expect(tags).to.have.lengthOf(2);

                        const tagLabels = Array.from(tags).map((tag) => tag.textContent.trim());
                        expect(tagLabels).to.include('Plans');
                        expect(tagLabels).to.include('Photoshop');
                    });

                    it('Should show Clear all link when filters are active', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.templateFilter = ['plans'];
                        await toolbar.updateComplete;

                        const clearAllLink = toolbar.shadowRoot.querySelector('.clear-all');
                        expect(clearAllLink).to.not.be.null;
                        expect(clearAllLink.textContent.trim()).to.equal('Clear all');
                    });

                    it('Should only delete the clicked tag when delete is triggered', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.templateFilter = ['plans', 'catalog'];
                        toolbar.productFilter = ['mas:product_code/phsp'];
                        await toolbar.updateComplete;

                        // Verify initial state
                        let tags = toolbar.shadowRoot.querySelectorAll('sp-tag');
                        expect(tags).to.have.lengthOf(3);

                        // Delete only the 'plans' tag
                        await simulateTagDelete(toolbar, 'template', 'plans');
                        await toolbar.updateComplete;

                        // Verify only 'plans' was removed
                        expect(toolbar.templateFilter).to.deep.equal(['catalog']);
                        expect(toolbar.productFilter).to.deep.equal(['mas:product_code/phsp']);

                        tags = toolbar.shadowRoot.querySelectorAll('sp-tag');
                        expect(tags).to.have.lengthOf(2);

                        const tagLabels = Array.from(tags).map((tag) => tag.textContent.trim());
                        expect(tagLabels).to.include('Catalog');
                        expect(tagLabels).to.include('Photoshop');
                        expect(tagLabels).to.not.include('Plans');
                    });

                    it('Should clear all filters when Clear all is clicked', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.templateFilter = ['plans'];
                        toolbar.marketSegmentFilter = ['mas:market_segment/edu'];
                        toolbar.productFilter = ['mas:product_code/phsp', 'mas:product_code/ilst'];
                        await toolbar.updateComplete;

                        // Verify initial tags
                        let tags = toolbar.shadowRoot.querySelectorAll('sp-tag');
                        expect(tags).to.have.lengthOf(4);

                        // Click Clear all
                        const clearAllLink = toolbar.shadowRoot.querySelector('.clear-all');
                        clearAllLink.click();
                        await toolbar.updateComplete;

                        // Verify all filters are cleared
                        expect(toolbar.templateFilter).to.deep.equal([]);
                        expect(toolbar.marketSegmentFilter).to.deep.equal([]);
                        expect(toolbar.customerSegmentFilter).to.deep.equal([]);
                        expect(toolbar.productFilter).to.deep.equal([]);

                        // Verify applied filters section is hidden
                        const appliedFilters = toolbar.shadowRoot.querySelector('.applied-filters');
                        expect(appliedFilters).to.be.null;
                    });

                    it('Should dispatch filter-change event when a tag is deleted', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.templateFilter = ['plans'];
                        toolbar.productFilter = ['mas:product_code/phsp'];
                        await toolbar.updateComplete;

                        const eventPromise = oneEvent(toolbar, 'filter-change');
                        await simulateTagDelete(toolbar, 'template', 'plans');

                        const event = await eventPromise;
                        expect(event.detail.template).to.deep.equal([]);
                        expect(event.detail.product).to.deep.equal(['mas:product_code/phsp']);
                    });

                    it('Should dispatch filter-change event when Clear all is clicked', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.templateFilter = ['plans'];
                        toolbar.productFilter = ['mas:product_code/phsp'];
                        await toolbar.updateComplete;

                        const eventPromise = oneEvent(toolbar, 'filter-change');
                        const clearAllLink = toolbar.shadowRoot.querySelector('.clear-all');
                        clearAllLink.click();

                        const event = await eventPromise;
                        expect(event.detail.template).to.deep.equal([]);
                        expect(event.detail.marketSegment).to.deep.equal([]);
                        expect(event.detail.customerSegment).to.deep.equal([]);
                        expect(event.detail.product).to.deep.equal([]);
                    });

                    it('Should update filter label with count when filters are active', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.templateFilter = ['plans', 'catalog'];
                        await toolbar.updateComplete;

                        const filterTriggers = toolbar.shadowRoot.querySelectorAll('.filter-trigger');
                        const templateTrigger = filterTriggers[0];
                        expect(templateTrigger.textContent.trim()).to.include('Template (2)');
                    });

                    it('Should dispatch search-change event when search input changes', async function () {
                        const toolbar = createToolbar(this.test.title);
                        await toolbar.updateComplete;

                        const eventPromise = oneEvent(toolbar, 'search-change');
                        const searchInput = toolbar.shadowRoot.querySelector('sp-search');
                        searchInput.value = 'test query';
                        searchInput.dispatchEvent(new Event('input', { bubbles: true }));

                        const event = await eventPromise;
                        expect(event.detail.query).to.equal('test query');
                    });

                    it('Should show correct result count', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.resultCount = 42;
                        await toolbar.updateComplete;

                        const resultCount = toolbar.shadowRoot.querySelector('.result-count');
                        expect(resultCount.textContent.trim()).to.equal('42 results');
                    });

                    it('Should show singular result text for count of 1', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.resultCount = 1;
                        await toolbar.updateComplete;

                        const resultCount = toolbar.shadowRoot.querySelector('.result-count');
                        expect(resultCount.textContent.trim()).to.equal('1 result');
                    });

                    it('Should show loading text when loading', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.loading = true;
                        await toolbar.updateComplete;

                        const resultCount = toolbar.shadowRoot.querySelector('.result-count');
                        expect(resultCount.textContent.trim()).to.equal('Loading...');
                    });

                    it('Should reset all filters and search via reset method', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.searchQuery = 'test';
                        toolbar.templateFilter = ['plans'];
                        toolbar.productFilter = ['mas:product_code/phsp'];
                        await toolbar.updateComplete;

                        toolbar.reset();
                        await toolbar.updateComplete;

                        expect(toolbar.searchQuery).to.equal('');
                        expect(toolbar.templateFilter).to.deep.equal([]);
                        expect(toolbar.marketSegmentFilter).to.deep.equal([]);
                        expect(toolbar.customerSegmentFilter).to.deep.equal([]);
                        expect(toolbar.productFilter).to.deep.equal([]);
                    });

                    it('Should return current filter state via getFilters method', async function () {
                        const toolbar = createToolbar(this.test.title);
                        toolbar.searchQuery = 'search term';
                        toolbar.templateFilter = ['plans'];
                        toolbar.marketSegmentFilter = ['mas:market_segment/edu'];
                        await toolbar.updateComplete;

                        const filters = toolbar.getFilters();
                        expect(filters.query).to.equal('search term');
                        expect(filters.template).to.deep.equal(['plans']);
                        expect(filters.marketSegment).to.deep.equal(['mas:market_segment/edu']);
                        expect(filters.customerSegment).to.deep.equal([]);
                        expect(filters.product).to.deep.equal([]);
                    });
                });
            });
        </script>
        <main>
            <sp-theme system="spectrum-two" color="light" scale="medium"></sp-theme>
        </main>
        <template id="toolbar1">
            <mas-fragment-picker-toolbar></mas-fragment-picker-toolbar>
        </template>
    </body>
</html>
